<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PR2AR_Primer • pr2ar</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="PR2AR_Primer">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">pr2ar</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/PR2AR_Primer.html">PR2AR_Primer</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>PR2AR_Primer</h1>
            
      
      
      <div class="hidden name"><code>PR2AR_Primer.Rmd</code></div>

    </div>

    
    
<div id="motivation" class="section level2">
<h2 class="hasAnchor">
<a href="#motivation" class="anchor"></a>Motivation</h2>
<p><span class="math inline">\(Pf\)</span>PR is the most frequently measured and estimated malaria metric, making it familiar to both modelers and policy makers. Despite its ubiquity, <span class="math inline">\(Pf\)</span>PR has substantial limitations as intelligence for policy development. Primarily, a given level of <span class="math inline">\(Pf\)</span>PR can be associated with a variety of transmission intensities based on differing levels of immunity, case detection rates, vector control, ages of infection, among other factors. The attack-rate, <span class="math inline">\(A(t)\)</span>, measures the probability of acquiring an infection during a time period of length <span class="math inline">\(t\)</span>. By developing an algorithm to simulate the latent attack-rate associated with a given time-series of <span class="math inline">\(Pf\)</span>PR, we enable investigation of risk of malaria infection. Measuring attack-rate – or force of infection (FoI) – directly requires cohort studies which are not universally available and can be expensive to conduct. Deriving estimates of attack-rate from <span class="math inline">\(Pf\)</span>PR with uniform methods allows for comparison of risk of malaria infection across locations and over time.</p>
</div>
<div id="a-bad-start" class="section level2">
<h2 class="hasAnchor">
<a href="#a-bad-start" class="anchor"></a>A Bad Start</h2>
<p>We assume that infections arise from a Poisson process with a rate equal to the FoI, <span class="math inline">\(h\)</span>, so that the probability of acquiring a new infection after <span class="math inline">\(t\)</span> days is <span class="math inline">\(A(t) = 1 - e^{-ht}\)</span>. Let <span class="math inline">\(Q(r, t) = e^{-r t}\)</span> denote the fraction of a cohort with recovery rate, <span class="math inline">\(r\)</span>, that naturally remains infected after <span class="math inline">\(t\)</span> days. It is tempting to start with the simple model: <span class="math display">\[\begin{equation} 
X_{t+1} = A_t (1 - X_t) + Q X_t  
\end{equation}\]</span> From this, we can solve for <span class="math inline">\(A_t\)</span>: <span class="math display">\[\begin{equation} 
A_t = \frac{X_{t+1} - Q X_t}{1-X_t} 
\end{equation}\]</span> At the steady state, <span class="math inline">\(X_{t+1} = X_t,\)</span> so we get the relationship: <span class="math display">\[\frac{A}{1-Q} = \frac{X}{1-X}\]</span> Note that <span class="math inline">\(A\)</span>, a probability, can be at most 1, so <span class="math inline">\(X \leq 1/(2-Q)\)</span>. If we take a 14-day time step and assume <span class="math inline">\(r = \frac{1}{200}\)</span>, then we get that Equation 2 gives nonsensical results for <span class="math inline">\(X &gt; 0.93\)</span>. Since there is no evidence that being infected protects against future infection, this is an artifact.</p>
</div>
<div id="a-better-start" class="section level2">
<h2 class="hasAnchor">
<a href="#a-better-start" class="anchor"></a>A Better Start</h2>
<p>We don’t want to work around artifacts, so what if we rethink the model. What if anyone can get infected, including the fraction that would have otherwise cleared their infections? The susceptible class is <span class="math inline">\(1-X_t + (1-Q)X_t\)</span>, or more simply: <span class="math display">\[\begin{equation} 
X_{t+1} = A_t (1 - Q X_t) + Q X_t  
\end{equation}\]</span> When <span class="math inline">\(A=1\)</span>, at the steady state, we get that <span class="math inline">\(X=1\)</span>.</p>
</div>
<div id="matrix-form" class="section level2">
<h2 class="hasAnchor">
<a href="#matrix-form" class="anchor"></a>Matrix Form</h2>
<p>One more wrinkle might help us write down equations without making errors. We will write down equations that assign a state to every person.<br><span class="math display">\[\begin{equation} \begin{array}{rl}
S_{t+1} &amp;=  (1-A_t) S_t + (1 - A_t)(1-Q)X_t\\
X_{t+1} &amp;=  A_t S_t + A_t(1 - Q)X_t  + Q X_t \\
\end{array} \end{equation}\]</span></p>
<p>Which we can rewrite in Markov matrix form, ensuring that all entries are positive and every column adds to 1. Let <span class="math inline">\(Y = \left&lt;S,X\right&gt;\)</span>, then we can rewrite these equations as <span class="math inline">\(Y_{t+1} = B Y_t\)</span> where <span class="math display">\[\begin{equation} B=
\left[ \begin{array}{cc}
1-A_t &amp; (1-A_t)(1-Q) \\
A_t &amp;  A_t(1 - Q) + Q \\
\end{array} \right]  \end{equation}\]</span> and we simply check to make sure all the columns sum to 1 to verify that <span class="math inline">\(B\)</span> is row stochastic. We really wish to solve for <span class="math inline">\(A_t\)</span>, so we write <span class="math inline">\(Y_{t+1} = A_t W Y_t + V Y_t\)</span>, where</p>
<p><span class="math display">\[\begin{equation} W=
\left[ \begin{array}{cc}
-1 &amp; -(1-Q)\\
1 &amp; 1 - Q  \\
\end{array} \right]  \end{equation}\]</span> and <span class="math display">\[\begin{equation} V =
\left[ \begin{array}{cc}
1 &amp; 1-Q \\
0 &amp;  Q \\
\end{array} \right] \end{equation}\]</span></p>
</div>
<div id="steady-state" class="section level2">
<h2 class="hasAnchor">
<a href="#steady-state" class="anchor"></a>Steady State</h2>
<p><span class="math inline">\(B\)</span> is a Markov matrix, which guarantees that the largest eigenvalue must equal 1 and the associated first right eigenvector, <span class="math inline">\(x_R\)</span>, is the stable equilibrium for the state vector <span class="math inline">\(Y\)</span>, such that <span class="math inline">\(B x_R = x_R\)</span>. We use this to solve for the steady state attack-rate associated with a given <span class="math inline">\(Pf\)</span>PR value.</p>
<p>Solving for the first right eigenvector <span class="math display">\[
(B - I) \cdot Y = 
\left[ \begin{array}{cc}
-A &amp; (1-A)(1-Q) \\
A &amp;  -(1-A)(1-Q)\\
\end{array} \right] \cdot Y = A S - (1 - A)(1 - Q)X = 0
\]</span> and including the fact that the sum of all states is 1 <span class="math display">\[S  =  1 - X\]</span> we get that <span class="math display">\[ X^* = \frac{A}{1-Q(1-A)} \]</span> and <span class="math display">\[ A^* = \frac{X - QX}{1-QX}\]</span></p>
<p>Alternatively, we can utilize a one dimensional optimization function to solve: <span class="math display">\[A^* = argmin_{A \in [0,1]} f(A) = |X - D Y_{eq}(A)|\]</span> where <span class="math display">\[Y_{eq}(A) = (A W + V) x_R = x_R\]</span></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co">## Solve for steady states using eigen function and algebraic solution</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co"># Set up example B</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>dt =<span class="st"> </span><span class="dv">10</span> <span class="co"># ten day time step</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>r =<span class="st"> </span><span class="dv">1</span> <span class="op">/</span><span class="st"> </span><span class="dv">200</span> <span class="co"># two hundred day duration of malaria infection</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>Q =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(<span class="op">-</span>r<span class="op">*</span>dt)</span>
<span id="cb1-6"><a href="#cb1-6"></a>A =<span class="st"> </span><span class="fl">0.1</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>PAR =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">A =</span> A, <span class="dt">Q =</span> Q)</span>
<span id="cb1-8"><a href="#cb1-8"></a>makeB &lt;-<span class="st"> </span><span class="cf">function</span>(PAR) {</span>
<span id="cb1-9"><a href="#cb1-9"></a>    A =<span class="st"> </span>PAR<span class="op">$</span>A</span>
<span id="cb1-10"><a href="#cb1-10"></a>    Q =<span class="st"> </span>PAR<span class="op">$</span>Q</span>
<span id="cb1-11"><a href="#cb1-11"></a>    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>A, A), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>((<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>A)<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>Q), A<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>Q) <span class="op">+</span><span class="st"> </span>Q))</span>
<span id="cb1-12"><a href="#cb1-12"></a></span>
<span id="cb1-13"><a href="#cb1-13"></a>}</span>
<span id="cb1-14"><a href="#cb1-14"></a>findYeq &lt;-<span class="st"> </span><span class="cf">function</span>(PAR, Bfn) {</span>
<span id="cb1-15"><a href="#cb1-15"></a>    B =<span class="st"> </span><span class="kw">Bfn</span>(PAR)</span>
<span id="cb1-16"><a href="#cb1-16"></a>    e =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/eigen">eigen</a></span>(B)</span>
<span id="cb1-17"><a href="#cb1-17"></a>    first =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/complex">Re</a></span>(e<span class="op">$</span>vectors[ ,<span class="dv">1</span>])</span>
<span id="cb1-18"><a href="#cb1-18"></a>    Yeq =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/vector">as.vector</a></span>(first <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(first))</span>
<span id="cb1-19"><a href="#cb1-19"></a>    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(Yeq) </span>
<span id="cb1-20"><a href="#cb1-20"></a>}</span>
<span id="cb1-21"><a href="#cb1-21"></a>Yeq1 =<span class="st"> </span><span class="kw"><a href="../reference/findYeq.html">findYeq</a></span>(PAR, makeB)</span>
<span id="cb1-22"><a href="#cb1-22"></a>Yeq1</span>
<span id="cb1-23"><a href="#cb1-23"></a><span class="co">#&gt; [1] 0.3050417 0.6949583</span></span>
<span id="cb1-24"><a href="#cb1-24"></a></span>
<span id="cb1-25"><a href="#cb1-25"></a><span class="co"># Find steady state algebraically</span></span>
<span id="cb1-26"><a href="#cb1-26"></a>algebYeq &lt;-<span class="st"> </span><span class="cf">function</span>(PAR) {</span>
<span id="cb1-27"><a href="#cb1-27"></a>    A =<span class="st"> </span>PAR<span class="op">$</span>A</span>
<span id="cb1-28"><a href="#cb1-28"></a>    Q =<span class="st"> </span>PAR<span class="op">$</span>Q</span>
<span id="cb1-29"><a href="#cb1-29"></a>    X =<span class="st"> </span>A <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>Q<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>A))</span>
<span id="cb1-30"><a href="#cb1-30"></a>    S  =<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>X</span>
<span id="cb1-31"><a href="#cb1-31"></a>    Yeq =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(S,X)</span>
<span id="cb1-32"><a href="#cb1-32"></a>    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(Yeq)</span>
<span id="cb1-33"><a href="#cb1-33"></a>}</span>
<span id="cb1-34"><a href="#cb1-34"></a>Yeq2 =<span class="st"> </span><span class="kw">algebYeq</span>(PAR)</span>
<span id="cb1-35"><a href="#cb1-35"></a>Yeq2</span>
<span id="cb1-36"><a href="#cb1-36"></a><span class="co">#&gt; [1] 0.3050417 0.6949583</span></span>
<span id="cb1-37"><a href="#cb1-37"></a></span>
<span id="cb1-38"><a href="#cb1-38"></a><span class="co"># Confirm steady state</span></span>
<span id="cb1-39"><a href="#cb1-39"></a>B =<span class="st"> </span><span class="kw"><a href="../reference/makeB.html">makeB</a></span>(PAR)</span>
<span id="cb1-40"><a href="#cb1-40"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(B <span class="op">%*%</span><span class="st"> </span>Yeq1 <span class="op">-</span><span class="st"> </span>Yeq1)</span>
<span id="cb1-41"><a href="#cb1-41"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb1-42"><a href="#cb1-42"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(B <span class="op">%*%</span><span class="st"> </span>Yeq2 <span class="op">-</span><span class="st"> </span>Yeq2)</span>
<span id="cb1-43"><a href="#cb1-43"></a><span class="co">#&gt; [1] 5.551115e-17</span></span>
<span id="cb1-44"><a href="#cb1-44"></a></span>
<span id="cb1-45"><a href="#cb1-45"></a><span class="co"># Convert attack-rate to equilibrium PR</span></span>
<span id="cb1-46"><a href="#cb1-46"></a>AR2PR &lt;-<span class="st"> </span><span class="cf">function</span>(A, PAR, Bfn, <span class="dt">eigen =</span> T) {</span>
<span id="cb1-47"><a href="#cb1-47"></a>    PR =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>()</span>
<span id="cb1-48"><a href="#cb1-48"></a>    <span class="cf">for</span>(Ai <span class="cf">in</span> A) {</span>
<span id="cb1-49"><a href="#cb1-49"></a>        PAR<span class="op">$</span>A =<span class="st"> </span>Ai</span>
<span id="cb1-50"><a href="#cb1-50"></a>        <span class="cf">if</span>(eigen) {</span>
<span id="cb1-51"><a href="#cb1-51"></a>            PRi =<span class="st"> </span><span class="kw"><a href="../reference/findYeq.html">findYeq</a></span>(PAR, Bfn)[<span class="dv">2</span>]</span>
<span id="cb1-52"><a href="#cb1-52"></a>        } <span class="cf">else</span> {</span>
<span id="cb1-53"><a href="#cb1-53"></a>            PRi =<span class="st"> </span><span class="kw">algebYeq</span>(PAR)[<span class="dv">2</span>]</span>
<span id="cb1-54"><a href="#cb1-54"></a>        }</span>
<span id="cb1-55"><a href="#cb1-55"></a>        PR =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(PR, PRi)        </span>
<span id="cb1-56"><a href="#cb1-56"></a>    }</span>
<span id="cb1-57"><a href="#cb1-57"></a>    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(PR)</span>
<span id="cb1-58"><a href="#cb1-58"></a>}</span>
<span id="cb1-59"><a href="#cb1-59"></a></span>
<span id="cb1-60"><a href="#cb1-60"></a><span class="co"># Plot</span></span>
<span id="cb1-61"><a href="#cb1-61"></a>A =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.05</span>)</span>
<span id="cb1-62"><a href="#cb1-62"></a>X =<span class="st"> </span><span class="kw"><a href="../reference/AR2PR.html">AR2PR</a></span>(A, PAR, makeB)</span>
<span id="cb1-63"><a href="#cb1-63"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(A, X, <span class="dt">type =</span> <span class="st">"l"</span>)</span></code></pre></div>
<p><img src="PR2AR_Primer_files/figure-html/unnamed-chunk-1-1.png" width="700"></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co">## Solve for attack-rate from X using optimize function and algebraic solution</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co"># optimize function</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>X =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.5</span>, <span class="fl">0.6</span>)</span>
<span id="cb2-5"><a href="#cb2-5"></a>fn &lt;-<span class="st"> </span><span class="cf">function</span>(A, PAR, Bfn, X) {</span>
<span id="cb2-6"><a href="#cb2-6"></a>    PR =<span class="st"> </span><span class="kw"><a href="../reference/AR2PR.html">AR2PR</a></span>(A, PAR, Bfn)</span>
<span id="cb2-7"><a href="#cb2-7"></a>    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">abs</a></span>(X <span class="op">-</span><span class="st"> </span>PR))</span>
<span id="cb2-8"><a href="#cb2-8"></a>}</span>
<span id="cb2-9"><a href="#cb2-9"></a>optimA &lt;-<span class="st"> </span><span class="cf">function</span>(X, PAR, Bfn) {</span>
<span id="cb2-10"><a href="#cb2-10"></a>    A &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>()</span>
<span id="cb2-11"><a href="#cb2-11"></a>    <span class="cf">for</span>(Xi <span class="cf">in</span> X) {</span>
<span id="cb2-12"><a href="#cb2-12"></a>        Ai &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/optimize">optimize</a></span>(fn, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">PAR =</span> PAR, <span class="dt">X =</span> Xi, <span class="dt">Bfn =</span> Bfn)<span class="op">$</span>minimum</span>
<span id="cb2-13"><a href="#cb2-13"></a>        A &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(A, Ai)</span>
<span id="cb2-14"><a href="#cb2-14"></a>    }</span>
<span id="cb2-15"><a href="#cb2-15"></a>    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(A)   </span>
<span id="cb2-16"><a href="#cb2-16"></a>}</span>
<span id="cb2-17"><a href="#cb2-17"></a><span class="kw"><a href="../reference/optimA.html">optimA</a></span>(X, PAR, makeB)</span>
<span id="cb2-18"><a href="#cb2-18"></a><span class="co">#&gt; [1] 0.04648978 0.06817784</span></span>
<span id="cb2-19"><a href="#cb2-19"></a></span>
<span id="cb2-20"><a href="#cb2-20"></a><span class="co"># Algebraic solution</span></span>
<span id="cb2-21"><a href="#cb2-21"></a>algebA &lt;-<span class="st"> </span><span class="cf">function</span>(X, PAR) {</span>
<span id="cb2-22"><a href="#cb2-22"></a>    Q =<span class="st"> </span>PAR<span class="op">$</span>Q</span>
<span id="cb2-23"><a href="#cb2-23"></a>    A =<span class="st"> </span>(X <span class="op">-</span><span class="st"> </span>Q<span class="op">*</span>X)<span class="op">/</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>Q<span class="op">*</span>X)</span>
<span id="cb2-24"><a href="#cb2-24"></a>    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(A)</span>
<span id="cb2-25"><a href="#cb2-25"></a>}</span>
<span id="cb2-26"><a href="#cb2-26"></a><span class="kw">algebA</span>(X, PAR)</span>
<span id="cb2-27"><a href="#cb2-27"></a><span class="co">#&gt; [1] 0.04650262 0.06816891</span></span>
<span id="cb2-28"><a href="#cb2-28"></a><span class="co">## Make plots</span></span>
<span id="cb2-29"><a href="#cb2-29"></a>X =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.05</span>)</span>
<span id="cb2-30"><a href="#cb2-30"></a>A1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/optimA.html">optimA</a></span>(X, PAR, makeB)</span>
<span id="cb2-31"><a href="#cb2-31"></a>A2 &lt;-<span class="st"> </span><span class="kw">algebA</span>(X, PAR)</span>
<span id="cb2-32"><a href="#cb2-32"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(X, A1, <span class="dt">ylab =</span> <span class="st">"A"</span>)</span>
<span id="cb2-33"><a href="#cb2-33"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(X, A2)</span></code></pre></div>
<p><img src="PR2AR_Primer_files/figure-html/unnamed-chunk-1-2.png" width="700"></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="co"># Convert PR to attack-rate</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>PR2AReq &lt;-<span class="st"> </span><span class="cf">function</span>(X, PAR, Bfn, <span class="dt">optim =</span> T) {</span>
<span id="cb3-4"><a href="#cb3-4"></a>    <span class="cf">if</span>(optim) {</span>
<span id="cb3-5"><a href="#cb3-5"></a>        AR =<span class="st"> </span><span class="kw"><a href="../reference/optimA.html">optimA</a></span>(X, PAR, Bfn)</span>
<span id="cb3-6"><a href="#cb3-6"></a>    } <span class="cf">else</span> {</span>
<span id="cb3-7"><a href="#cb3-7"></a>        AR =<span class="st"> </span><span class="kw">algebA</span>(X, PAR)</span>
<span id="cb3-8"><a href="#cb3-8"></a>    }</span>
<span id="cb3-9"><a href="#cb3-9"></a>    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(AR)</span>
<span id="cb3-10"><a href="#cb3-10"></a>}</span></code></pre></div>
</div>
<div id="forward-simulation-vs--steady-state" class="section level2">
<h2 class="hasAnchor">
<a href="#forward-simulation-vs--steady-state" class="anchor"></a>Forward Simulation vs. Steady State</h2>
<p>Of course, we don’t know <span class="math inline">\(Y_t\)</span> but we do know <span class="math inline">\(X_t\)</span>, estimated <span class="math inline">\(Pf\)</span>PR. We let <span class="math inline">\(D\)</span> denote the row vector that maps <span class="math inline">\(Y\)</span> onto <span class="math inline">\(X\)</span>: <span class="math inline">\(D = \left&lt;0,1 \right&gt;\)</span> and <span class="math display">\[X = D \cdot Y = \left[ 
\begin{array}{cc}
0 &amp; 1
\end{array} \right] \cdot 
\left[ 
\begin{array}{c}
S\\
X\\
\end{array} \right] \]</span> To solve for the scalar <span class="math inline">\(A_t\)</span>, we simply solve the two-step equation <span class="math display">\[D Y_{t+1} 
= D B Y_t = D \left( A_t W Y_t +  V Y_t \right),\]</span> so <span class="math display">\[A_t = \left( X_{t + 1} - D V Y_t  \right) / \left( D W Y_t \right).\]</span></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="co">## Compare steady state solutions to forward simulation</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>D =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/t">t</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb4-3"><a href="#cb4-3"></a>X =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="fl">0.3</span>, <span class="fl">0.6</span>, <span class="fl">0.01</span>), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="fl">0.59</span>, <span class="fl">0.3</span>, <span class="fl">-0.01</span>))</span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="co"># Find steady state values for X</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>steadyA =<span class="st"> </span><span class="kw"><a href="../reference/optimA.html">optimA</a></span>(X, PAR, makeB)</span>
<span id="cb4-6"><a href="#cb4-6"></a></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co"># Generate W and V matrices</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>makeW &lt;-<span class="st"> </span><span class="cf">function</span>(PAR) {</span>
<span id="cb4-9"><a href="#cb4-9"></a>    Q =<span class="st"> </span>PAR<span class="op">$</span>Q</span>
<span id="cb4-10"><a href="#cb4-10"></a>    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="op">-</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>Q), (<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>Q)))</span>
<span id="cb4-11"><a href="#cb4-11"></a>}</span>
<span id="cb4-12"><a href="#cb4-12"></a>W =<span class="st"> </span><span class="kw"><a href="../reference/makeW.html">makeW</a></span>(PAR)</span>
<span id="cb4-13"><a href="#cb4-13"></a>makeV &lt;-<span class="st"> </span><span class="cf">function</span>(PAR) {</span>
<span id="cb4-14"><a href="#cb4-14"></a>    Q =<span class="st"> </span>PAR<span class="op">$</span>Q</span>
<span id="cb4-15"><a href="#cb4-15"></a>    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, <span class="dv">0</span>), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>Q, Q))</span>
<span id="cb4-16"><a href="#cb4-16"></a>}</span>
<span id="cb4-17"><a href="#cb4-17"></a>V =<span class="st"> </span><span class="kw"><a href="../reference/makeV.html">makeV</a></span>(PAR)</span>
<span id="cb4-18"><a href="#cb4-18"></a></span>
<span id="cb4-19"><a href="#cb4-19"></a><span class="co"># Set up equilibrium start values</span></span>
<span id="cb4-20"><a href="#cb4-20"></a>forwardA =<span class="st"> </span>PAR<span class="op">$</span>A =<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(steadyA[<span class="dv">1</span>])</span>
<span id="cb4-21"><a href="#cb4-21"></a>Y =<span class="st"> </span><span class="kw">algebYeq</span>(PAR)</span>
<span id="cb4-22"><a href="#cb4-22"></a><span class="co"># Simulate forward</span></span>
<span id="cb4-23"><a href="#cb4-23"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(X)) {</span>
<span id="cb4-24"><a href="#cb4-24"></a>    forwardA[i] =<span class="st"> </span>PAR<span class="op">$</span>A =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>((X[i] <span class="op">-</span><span class="st"> </span>D<span class="op">%*%</span>V<span class="op">%*%</span>Y) <span class="op">/</span><span class="st"> </span>(D<span class="op">%*%</span>W<span class="op">%*%</span>Y))</span>
<span id="cb4-25"><a href="#cb4-25"></a>    B =<span class="st"> </span><span class="kw"><a href="../reference/makeB.html">makeB</a></span>(PAR)</span>
<span id="cb4-26"><a href="#cb4-26"></a>    Y =<span class="st"> </span>B<span class="op">%*%</span>Y</span>
<span id="cb4-27"><a href="#cb4-27"></a>}</span>
<span id="cb4-28"><a href="#cb4-28"></a> </span>
<span id="cb4-29"><a href="#cb4-29"></a><span class="co"># Plot</span></span>
<span id="cb4-30"><a href="#cb4-30"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(steadyA, <span class="dt">type =</span> <span class="st">"l"</span>, <span class="dt">ylab =</span> <span class="st">"A"</span>, </span>
<span id="cb4-31"><a href="#cb4-31"></a>     <span class="dt">ylim =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(steadyA, forwardA)), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(steadyA, forwardA))))</span>
<span id="cb4-32"><a href="#cb4-32"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(forwardA, <span class="dt">lty =</span> <span class="st">"dashed"</span>)</span>
<span id="cb4-33"><a href="#cb4-33"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/legend">legend</a></span>(<span class="st">"topleft"</span>, <span class="dt">legend =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"Steady"</span>, <span class="st">"Forward"</span>), <span class="dt">lty =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)</span></code></pre></div>
<p><img src="PR2AR_Primer_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
</div>
<div id="adding-drugs" class="section level2">
<h2 class="hasAnchor">
<a href="#adding-drugs" class="anchor"></a>Adding Drugs</h2>
<p>Let <span class="math inline">\(\rho\)</span> denote the fraction of incident malaria infections that are treated and cured. Let <span class="math inline">\(\delta\)</span> denote the rate anti-malarial drugs are used without a confirmed malaria case attributable to malaria. <span class="math inline">\(C\)</span> is now a state variable denoting the proportion of the population on treatment.</p>
<p><span class="math display">\[\begin{equation} \begin{array}{rl}
S_{t+1} &amp;=  (1-\delta)(1-A_t) S_t + (1-A \rho)(1-Q) X_t + (1-\delta) C_t \\
X_{t+1} &amp;= (1-\rho) A_t S_t  +(1-\delta)(1-A \rho) Q X_t \\
C_{t+1} &amp;= (\delta + (1-\delta)\rho A_t ) S_t + (\rho A_t + \delta) X_t  + \delta
\end{array} \end{equation}\]</span></p>
<p>Now, <span class="math inline">\(Y = \left&lt;S,X,C \right&gt;\)</span>, <span class="math inline">\(D = \left&lt;0,1,0 \right&gt;\)</span> and <span class="math display">\[\begin{equation} B=
\left[ \begin{array}{ccc}
(1-\delta)(1-A_t) &amp; (1-\delta)(1-A_t \rho)(1-Q) &amp;  1 - \delta \\
(1-\delta)(1-\rho) A_t &amp;  (1-\delta)(1-A_t \rho)  Q  &amp; 0 \\
\delta + (1-\delta)\rho A_t &amp; \delta + (1-\delta)\rho A_t  &amp;  \delta\\
\end{array} \right]  \end{equation}\]</span></p>
<p><span class="math display">\[\begin{equation} W=
(1-\delta)\left[ \begin{array}{ccc}
-1&amp; -\rho(1-Q) &amp; 0  \\
1-\rho &amp;  - \rho Q &amp; 0 \\
\rho  &amp;  \rho   &amp;  0 \\
\end{array} \right]  \end{equation}\]</span></p>
<p><span class="math display">\[\begin{equation} V =
(1-\delta) \left[ \begin{array}{ccc}
1 &amp; 1-Q &amp;  1 \\
0 &amp;  Q &amp; 0 \\
\delta / (1 - \delta) &amp;  \delta / (1 - \delta) &amp;  \delta / (1 - \delta)\\
\end{array} \right] \end{equation}\]</span></p>
<p>Solving for <span class="math inline">\(Y\)</span> at equilibrium is now critical because there are two unknowns, namely <span class="math inline">\(S\)</span> and <span class="math inline">\(C\)</span>, for a given value of <span class="math inline">\(X\)</span>.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co">## Solve for steady states using eigen function and algebraic solution</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co"># Set up example B</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>PAR<span class="op">$</span>d =<span class="st"> </span><span class="fl">0.05</span> <span class="co"># rate of anti-malarial drug user w/0 confirmed malaria</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>PAR<span class="op">$</span>rho =<span class="st"> </span><span class="fl">0.1</span><span class="co"># fraction of incident malaria cases that are treated and cured</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>makeBdrugs &lt;-<span class="st"> </span><span class="cf">function</span>(PAR) {</span>
<span id="cb5-6"><a href="#cb5-6"></a>    A =<span class="st"> </span>PAR<span class="op">$</span>A; Q =<span class="st"> </span>PAR<span class="op">$</span>Q; d =<span class="st"> </span>PAR<span class="op">$</span>d; rho =<span class="st"> </span>PAR<span class="op">$</span>rho</span>
<span id="cb5-7"><a href="#cb5-7"></a>    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>((<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>d)<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>A), (<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>d)<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>rho)<span class="op">*</span>A, d <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>d)<span class="op">*</span>rho<span class="op">*</span>A), </span>
<span id="cb5-8"><a href="#cb5-8"></a>          <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>((<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>d)<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>A<span class="op">*</span>rho)<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>Q), (<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>d)<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>A<span class="op">*</span>rho)<span class="op">*</span>Q, d <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>d)<span class="op">*</span>rho<span class="op">*</span>A),</span>
<span id="cb5-9"><a href="#cb5-9"></a>          <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>d, <span class="dv">0</span>, d))</span>
<span id="cb5-10"><a href="#cb5-10"></a>}</span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colSums">colSums</a></span>(<span class="kw"><a href="../reference/makeBdrugs.html">makeBdrugs</a></span>(PAR))</span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="co">#&gt; [1] 1 1 1</span></span>
<span id="cb5-13"><a href="#cb5-13"></a>Yeq =<span class="st"> </span><span class="kw"><a href="../reference/findYeq.html">findYeq</a></span>(PAR, makeBdrugs)</span>
<span id="cb5-14"><a href="#cb5-14"></a>Yeq</span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="co">#&gt; [1] 0.89224423 0.05710104 0.05065473</span></span>
<span id="cb5-16"><a href="#cb5-16"></a></span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="co"># Confirm steady state</span></span>
<span id="cb5-18"><a href="#cb5-18"></a>B =<span class="st"> </span><span class="kw"><a href="../reference/makeBdrugs.html">makeBdrugs</a></span>(PAR)</span>
<span id="cb5-19"><a href="#cb5-19"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(B <span class="op">%*%</span><span class="st"> </span>Yeq <span class="op">-</span><span class="st"> </span>Yeq)</span>
<span id="cb5-20"><a href="#cb5-20"></a><span class="co">#&gt; [1] 5.551115e-17</span></span>
<span id="cb5-21"><a href="#cb5-21"></a></span>
<span id="cb5-22"><a href="#cb5-22"></a><span class="co">## Make plots comparing to no treatment</span></span>
<span id="cb5-23"><a href="#cb5-23"></a>simpleA =<span class="st"> </span><span class="kw"><a href="../reference/PR2AReq.html">PR2AReq</a></span>(X, PAR, makeB)</span>
<span id="cb5-24"><a href="#cb5-24"></a>drugsA =<span class="st"> </span><span class="kw"><a href="../reference/PR2AReq.html">PR2AReq</a></span>(X, PAR, makeBdrugs)</span>
<span id="cb5-25"><a href="#cb5-25"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(steadyA, <span class="dt">type =</span> <span class="st">"l"</span>, <span class="dt">ylab =</span> <span class="st">"A"</span>, </span>
<span id="cb5-26"><a href="#cb5-26"></a>     <span class="dt">ylim =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(simpleA, drugsA)), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(simpleA, drugsA))))</span>
<span id="cb5-27"><a href="#cb5-27"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(drugsA, <span class="dt">lty =</span> <span class="st">"dashed"</span>)</span>
<span id="cb5-28"><a href="#cb5-28"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/legend">legend</a></span>(<span class="st">"topleft"</span>, <span class="dt">legend =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"Simple Model (SM)"</span>, <span class="st">"SM with Drugs"</span>), <span class="dt">lty =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)</span></code></pre></div>
<p><img src="PR2AR_Primer_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="co"># Update AR2PR to accomodate treatment class</span></span>
<span id="cb6-3"><a href="#cb6-3"></a>AR2PR &lt;-<span class="st"> </span><span class="cf">function</span>(A, PAR, Bfn, <span class="dt">eigen =</span> T) {</span>
<span id="cb6-4"><a href="#cb6-4"></a>    PR =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>()</span>
<span id="cb6-5"><a href="#cb6-5"></a>    <span class="cf">for</span>(Ai <span class="cf">in</span> A) {</span>
<span id="cb6-6"><a href="#cb6-6"></a>        PAR<span class="op">$</span>A =<span class="st"> </span>Ai</span>
<span id="cb6-7"><a href="#cb6-7"></a>        <span class="cf">if</span>(eigen) {</span>
<span id="cb6-8"><a href="#cb6-8"></a>            eq =<span class="st"> </span><span class="kw"><a href="../reference/findYeq.html">findYeq</a></span>(PAR, Bfn)</span>
<span id="cb6-9"><a href="#cb6-9"></a>        } <span class="cf">else</span> {</span>
<span id="cb6-10"><a href="#cb6-10"></a>            eq =<span class="st"> </span><span class="kw">algebYeq</span>(PAR)</span>
<span id="cb6-11"><a href="#cb6-11"></a>        }</span>
<span id="cb6-12"><a href="#cb6-12"></a>        PR =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(PR, eq[<span class="dv">2</span>])</span>
<span id="cb6-13"><a href="#cb6-13"></a>        <span class="cf">if</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(eq) <span class="op">==</span><span class="st"> </span><span class="dv">3</span>) {</span>
<span id="cb6-14"><a href="#cb6-14"></a>            <span class="cf">if</span>(Ai <span class="op">==</span><span class="st"> </span>A[<span class="dv">1</span>]) {</span>
<span id="cb6-15"><a href="#cb6-15"></a>                C =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(eq[<span class="dv">3</span>])</span>
<span id="cb6-16"><a href="#cb6-16"></a>            } <span class="cf">else</span> {</span>
<span id="cb6-17"><a href="#cb6-17"></a>                C =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(C, eq[<span class="dv">3</span>])</span>
<span id="cb6-18"><a href="#cb6-18"></a>            }</span>
<span id="cb6-19"><a href="#cb6-19"></a>        }</span>
<span id="cb6-20"><a href="#cb6-20"></a>    }</span>
<span id="cb6-21"><a href="#cb6-21"></a>    <span class="cf">if</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(eq) <span class="op">==</span><span class="st"> </span><span class="dv">3</span>) {</span>
<span id="cb6-22"><a href="#cb6-22"></a>        out.list =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">X =</span> PR, <span class="dt">C =</span> C)</span>
<span id="cb6-23"><a href="#cb6-23"></a>    } <span class="cf">else</span> {</span>
<span id="cb6-24"><a href="#cb6-24"></a>        out.list =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">X =</span> PR)</span>
<span id="cb6-25"><a href="#cb6-25"></a>    }</span>
<span id="cb6-26"><a href="#cb6-26"></a>    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(out.list)</span>
<span id="cb6-27"><a href="#cb6-27"></a>}</span>
<span id="cb6-28"><a href="#cb6-28"></a></span>
<span id="cb6-29"><a href="#cb6-29"></a><span class="co">## Plot for a range of treatment rates </span></span>
<span id="cb6-30"><a href="#cb6-30"></a>plotAR2PR &lt;-<span class="st"> </span><span class="cf">function</span>(PAR, Bfn, <span class="dt">AR_range =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.01</span>, <span class="dv">1</span>), <span class="dt">logX =</span> T, <span class="dt">logY =</span> F, </span>
<span id="cb6-31"><a href="#cb6-31"></a>                      <span class="dt">plotC =</span> T, <span class="dt">plotXover1_C =</span> F) {</span>
<span id="cb6-32"><a href="#cb6-32"></a>  <span class="co"># Prep data</span></span>
<span id="cb6-33"><a href="#cb6-33"></a>  AR =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(AR_range[<span class="dv">1</span>], AR_range[<span class="dv">2</span>], <span class="dt">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb6-34"><a href="#cb6-34"></a>  rho =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="dv">0</span>, <span class="fl">0.075</span>, <span class="fl">0.025</span>), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="fl">0.1</span>, <span class="fl">0.8</span>, <span class="fl">.1</span>))</span>
<span id="cb6-35"><a href="#cb6-35"></a>  dt &lt;-<span class="st"> </span><span class="kw">data.table</span>()</span>
<span id="cb6-36"><a href="#cb6-36"></a>  <span class="cf">for</span>(rho_i <span class="cf">in</span> rho) {</span>
<span id="cb6-37"><a href="#cb6-37"></a>    PAR<span class="op">$</span>rho &lt;-<span class="st"> </span>rho_i</span>
<span id="cb6-38"><a href="#cb6-38"></a>    PR &lt;-<span class="st"> </span><span class="kw"><a href="../reference/AR2PR.html">AR2PR</a></span>(AR, PAR, Bfn)</span>
<span id="cb6-39"><a href="#cb6-39"></a>    X_i =<span class="st"> </span>PR<span class="op">$</span>X</span>
<span id="cb6-40"><a href="#cb6-40"></a>    C_i =<span class="st"> </span>PR<span class="op">$</span>C</span>
<span id="cb6-41"><a href="#cb6-41"></a>    add.dt &lt;-<span class="st">  </span><span class="kw">data.table</span>(<span class="dt">AR =</span> AR, <span class="dt">rho =</span> rho_i, <span class="dt">X =</span> X_i, <span class="dt">C =</span> C_i)</span>
<span id="cb6-42"><a href="#cb6-42"></a>    dt &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">rbind</a></span>(dt, add.dt)</span>
<span id="cb6-43"><a href="#cb6-43"></a>  }</span>
<span id="cb6-44"><a href="#cb6-44"></a>  </span>
<span id="cb6-45"><a href="#cb6-45"></a>  <span class="co"># Plot</span></span>
<span id="cb6-46"><a href="#cb6-46"></a>  gg &lt;-<span class="st"> </span><span class="kw">ggplot</span>(dt, <span class="kw">aes</span>(<span class="dt">x =</span> AR, <span class="dt">y =</span> X)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>() <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>rho) <span class="op">+</span><span class="st"> </span></span>
<span id="cb6-47"><a href="#cb6-47"></a><span class="st">    </span><span class="kw">theme_classic</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb6-48"><a href="#cb6-48"></a><span class="st">      </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">"Attack-rate and PfPR for different case management rates"</span>,</span>
<span id="cb6-49"><a href="#cb6-49"></a>           <span class="dt">subtitle =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"Anti-malarial drug use w/o confirmed malaria: "</span>, PAR<span class="op">$</span>d)) <span class="op">+</span></span>
<span id="cb6-50"><a href="#cb6-50"></a><span class="st">    </span><span class="kw">xlab</span>(<span class="st">"Attack-rate"</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ylab</span>(<span class="st">"PfPR"</span>)</span>
<span id="cb6-51"><a href="#cb6-51"></a>  <span class="cf">if</span>(logX) {</span>
<span id="cb6-52"><a href="#cb6-52"></a>    gg =<span class="st"> </span>gg <span class="op">+</span><span class="st"> </span><span class="kw">scale_x_continuous</span>(<span class="dt">trans=</span><span class="st">'log10'</span>)</span>
<span id="cb6-53"><a href="#cb6-53"></a>  }</span>
<span id="cb6-54"><a href="#cb6-54"></a>  <span class="cf">if</span>(logY) {</span>
<span id="cb6-55"><a href="#cb6-55"></a>    gg =<span class="st"> </span>gg <span class="op">+</span><span class="st"> </span><span class="kw">scale_y_continuous</span>(<span class="dt">trans=</span><span class="st">'log10'</span>)</span>
<span id="cb6-56"><a href="#cb6-56"></a>  } <span class="cf">else</span> {</span>
<span id="cb6-57"><a href="#cb6-57"></a>    gg =<span class="st"> </span>gg <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot.window">ylim</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb6-58"><a href="#cb6-58"></a>  }</span>
<span id="cb6-59"><a href="#cb6-59"></a>  <span class="cf">if</span>(plotC) {</span>
<span id="cb6-60"><a href="#cb6-60"></a>    top.dt &lt;-<span class="st"> </span><span class="kw">copy</span>(dt)[, C <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]</span>
<span id="cb6-61"><a href="#cb6-61"></a>    top.dt &lt;-<span class="st"> </span>top.dt[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(top.dt) <span class="op">-</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(top.dt) <span class="op">+</span><span class="st"> </span><span class="dv">1</span>]</span>
<span id="cb6-62"><a href="#cb6-62"></a>    poly.dt &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">rbind</a></span>(dt, top.dt)</span>
<span id="cb6-63"><a href="#cb6-63"></a>    gg =<span class="st"> </span>gg <span class="op">+</span><span class="st"> </span><span class="kw">geom_polygon</span>(<span class="dt">data =</span> poly.dt, <span class="kw">aes</span>(<span class="dt">x=</span> AR, <span class="dt">y =</span> (<span class="dv">1</span><span class="op">-</span>C), <span class="dt">fill =</span> <span class="st">"Treated"</span>), <span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span></span>
<span id="cb6-64"><a href="#cb6-64"></a><span class="st">         </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">"bottom"</span>, <span class="dt">legend.title =</span> <span class="kw">element_blank</span>())</span>
<span id="cb6-65"><a href="#cb6-65"></a>  }</span>
<span id="cb6-66"><a href="#cb6-66"></a>  <span class="cf">if</span>(plotXover1_C) {</span>
<span id="cb6-67"><a href="#cb6-67"></a>    gg =<span class="st"> </span>gg <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> AR, <span class="dt">y =</span> X <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>C)), <span class="dt">color =</span> <span class="st">"red"</span>)</span>
<span id="cb6-68"><a href="#cb6-68"></a>  }</span>
<span id="cb6-69"><a href="#cb6-69"></a>  gg</span>
<span id="cb6-70"><a href="#cb6-70"></a>}</span>
<span id="cb6-71"><a href="#cb6-71"></a></span>
<span id="cb6-72"><a href="#cb6-72"></a><span class="kw">plotAR2PR</span>(PAR, makeBdrugs)</span></code></pre></div>
<p><img src="PR2AR_Primer_files/figure-html/unnamed-chunk-3-2.png" width="700"></p>
</div>
<div id="pfpr-thresholds-and-ar2pr-monotonicity" class="section level2">
<h2 class="hasAnchor">
<a href="#pfpr-thresholds-and-ar2pr-monotonicity" class="anchor"></a><span class="math inline">\(Pf\)</span>PR Thresholds and AR2PR Monotonicity</h2>
<p>As can be seen in the preceding plots, for a given level of drug use there are levels of <span class="math inline">\(Pf\)</span>PR that are not plausible. These thresholds can assist with identifying a disconnect between estimated case management and <span class="math inline">\(Pf\)</span>PR. In addition, the relationship between AR and PR is not monotonic for certain levels of treatment, leading to two solutions for a given <span class="math inline">\(Pf\)</span>PR that exceeds the PR associated with an AR of 1 but is less than the maximum allowable PR. In order to address both of these phenomenon we will introduce boundary conditions and report both possible AR values when convert from <span class="math inline">\(Pf\)</span>PR to AR.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>AR2PRopt &lt;-<span class="st"> </span><span class="cf">function</span>(A, PAR, Bfn) {</span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="kw"><a href="../reference/AR2PR.html">AR2PR</a></span>(A, PAR, Bfn)<span class="op">$</span>X</span>
<span id="cb7-3"><a href="#cb7-3"></a>}</span>
<span id="cb7-4"><a href="#cb7-4"></a></span>
<span id="cb7-5"><a href="#cb7-5"></a>findAXmax &lt;-<span class="st"> </span><span class="cf">function</span>(PAR, Bfn) {</span>
<span id="cb7-6"><a href="#cb7-6"></a>  opt &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/optimize">optimize</a></span>(AR2PRopt, <span class="dt">interval =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="dv">1</span>), PAR, Bfn, <span class="dt">maximum =</span> T)</span>
<span id="cb7-7"><a href="#cb7-7"></a>  A =<span class="st"> </span>opt<span class="op">$</span>maximum</span>
<span id="cb7-8"><a href="#cb7-8"></a>  X =<span class="st"> </span>opt<span class="op">$</span>objective</span>
<span id="cb7-9"><a href="#cb7-9"></a>  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">A =</span> A, <span class="dt">X =</span> X))</span>
<span id="cb7-10"><a href="#cb7-10"></a>}</span>
<span id="cb7-11"><a href="#cb7-11"></a></span>
<span id="cb7-12"><a href="#cb7-12"></a>PAR<span class="op">$</span>rho =<span class="st"> </span><span class="fl">0.5</span></span>
<span id="cb7-13"><a href="#cb7-13"></a>max =<span class="st"> </span><span class="kw"><a href="../reference/findAXmax.html">findAXmax</a></span>(PAR, makeBdrugs)</span>
<span id="cb7-14"><a href="#cb7-14"></a>max </span>
<span id="cb7-15"><a href="#cb7-15"></a><span class="co">#&gt; $A</span></span>
<span id="cb7-16"><a href="#cb7-16"></a><span class="co">#&gt; [1] 0.4677827</span></span>
<span id="cb7-17"><a href="#cb7-17"></a><span class="co">#&gt; </span></span>
<span id="cb7-18"><a href="#cb7-18"></a><span class="co">#&gt; $X</span></span>
<span id="cb7-19"><a href="#cb7-19"></a><span class="co">#&gt; [1] 0.3259383</span></span>
<span id="cb7-20"><a href="#cb7-20"></a></span>
<span id="cb7-21"><a href="#cb7-21"></a>fn &lt;-<span class="st"> </span><span class="cf">function</span>(A, PAR, Bfn, X) {</span>
<span id="cb7-22"><a href="#cb7-22"></a>    PR =<span class="st"> </span><span class="kw"><a href="../reference/AR2PR.html">AR2PR</a></span>(A, PAR, Bfn)<span class="op">$</span>X</span>
<span id="cb7-23"><a href="#cb7-23"></a>    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">abs</a></span>(X <span class="op">-</span><span class="st"> </span>PR))</span>
<span id="cb7-24"><a href="#cb7-24"></a>}</span>
<span id="cb7-25"><a href="#cb7-25"></a></span>
<span id="cb7-26"><a href="#cb7-26"></a>PR2AReq &lt;-<span class="st"> </span><span class="cf">function</span>(X, PAR, Bfn) {</span>
<span id="cb7-27"><a href="#cb7-27"></a>  A1X &lt;-<span class="st"> </span><span class="kw"><a href="../reference/AR2PR.html">AR2PR</a></span>(<span class="dv">1</span>, PAR, Bfn)</span>
<span id="cb7-28"><a href="#cb7-28"></a>  max &lt;-<span class="st"> </span><span class="kw"><a href="../reference/findAXmax.html">findAXmax</a></span>(PAR, Bfn)</span>
<span id="cb7-29"><a href="#cb7-29"></a>  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"max A: "</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">round</a></span>(max<span class="op">$</span>A, <span class="dv">3</span>), <span class="st">"; max X: "</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">round</a></span>(max<span class="op">$</span>X, <span class="dv">3</span>)))</span>
<span id="cb7-30"><a href="#cb7-30"></a>  mono &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">abs</a></span>(A1X<span class="op">$</span>X <span class="op">-</span><span class="st"> </span>max<span class="op">$</span>X) <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.001</span></span>
<span id="cb7-31"><a href="#cb7-31"></a>  <span class="cf">if</span>(mono) {</span>
<span id="cb7-32"><a href="#cb7-32"></a>    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="st">"Monotonic"</span>)</span>
<span id="cb7-33"><a href="#cb7-33"></a>  } <span class="cf">else</span> {</span>
<span id="cb7-34"><a href="#cb7-34"></a>    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="st">"Non-monotonic"</span>)</span>
<span id="cb7-35"><a href="#cb7-35"></a>    outA2 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>()</span>
<span id="cb7-36"><a href="#cb7-36"></a>    outY2 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">matrix</a></span>(<span class="dt">nrow =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(<span class="kw">Bfn</span>(PAR)), <span class="dt">ncol =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(X))</span>
<span id="cb7-37"><a href="#cb7-37"></a>  }</span>
<span id="cb7-38"><a href="#cb7-38"></a>  outA &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>()</span>
<span id="cb7-39"><a href="#cb7-39"></a>  outY &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">matrix</a></span>(<span class="dt">nrow =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(<span class="kw">Bfn</span>(PAR)), <span class="dt">ncol =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(X))</span>
<span id="cb7-40"><a href="#cb7-40"></a>  <span class="cf">for</span>(Xi <span class="cf">in</span> X) {</span>
<span id="cb7-41"><a href="#cb7-41"></a>    <span class="cf">if</span>(Xi <span class="op">&gt;</span><span class="st"> </span>max<span class="op">$</span>X) {</span>
<span id="cb7-42"><a href="#cb7-42"></a>      outA &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(outA, <span class="ot">NA</span>)</span>
<span id="cb7-43"><a href="#cb7-43"></a>      outA2 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(outA2, <span class="ot">NA</span>)</span>
<span id="cb7-44"><a href="#cb7-44"></a>      <span class="cf">next</span></span>
<span id="cb7-45"><a href="#cb7-45"></a>    }</span>
<span id="cb7-46"><a href="#cb7-46"></a>    A =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/optimize">optimize</a></span>(fn, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, max<span class="op">$</span>A), <span class="dt">PAR =</span> PAR, <span class="dt">X =</span> Xi, <span class="dt">Bfn =</span> Bfn)<span class="op">$</span>minimum</span>
<span id="cb7-47"><a href="#cb7-47"></a>    outA =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(outA, A)</span>
<span id="cb7-48"><a href="#cb7-48"></a>    PAR<span class="op">$</span>A =<span class="st"> </span>A</span>
<span id="cb7-49"><a href="#cb7-49"></a>    Y =<span class="st"> </span><span class="kw"><a href="../reference/findYeq.html">findYeq</a></span>(PAR, Bfn)</span>
<span id="cb7-50"><a href="#cb7-50"></a>    outY[, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(X <span class="op">==</span><span class="st"> </span>Xi)] =<span class="st"> </span>Y</span>
<span id="cb7-51"><a href="#cb7-51"></a>    <span class="cf">if</span>(<span class="op">!</span>mono) {</span>
<span id="cb7-52"><a href="#cb7-52"></a>      <span class="cf">if</span>(Xi <span class="op">&gt;</span><span class="st"> </span>A1X<span class="op">$</span>X) {</span>
<span id="cb7-53"><a href="#cb7-53"></a>        A =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/optimize">optimize</a></span>(fn, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(max<span class="op">$</span>A, <span class="dv">1</span>), <span class="dt">PAR =</span> PAR, <span class="dt">X =</span> Xi, <span class="dt">Bfn =</span> Bfn)<span class="op">$</span>minimum</span>
<span id="cb7-54"><a href="#cb7-54"></a>        outA2 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(outA2, A)</span>
<span id="cb7-55"><a href="#cb7-55"></a>        PAR<span class="op">$</span>A =<span class="st"> </span>A</span>
<span id="cb7-56"><a href="#cb7-56"></a>        Y =<span class="st"> </span><span class="kw"><a href="../reference/findYeq.html">findYeq</a></span>(PAR, Bfn)</span>
<span id="cb7-57"><a href="#cb7-57"></a>        outY2[, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(X <span class="op">==</span><span class="st"> </span>Xi)] &lt;-<span class="st"> </span>Y</span>
<span id="cb7-58"><a href="#cb7-58"></a>      } <span class="cf">else</span> {</span>
<span id="cb7-59"><a href="#cb7-59"></a>        outA2 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(outA2, <span class="ot">NA</span>)</span>
<span id="cb7-60"><a href="#cb7-60"></a>      }</span>
<span id="cb7-61"><a href="#cb7-61"></a>    }</span>
<span id="cb7-62"><a href="#cb7-62"></a>  }</span>
<span id="cb7-63"><a href="#cb7-63"></a>  <span class="cf">if</span>(mono) {</span>
<span id="cb7-64"><a href="#cb7-64"></a>    outList =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">A =</span> outA, <span class="dt">Y =</span> outY)</span>
<span id="cb7-65"><a href="#cb7-65"></a>  } <span class="cf">else</span> {</span>
<span id="cb7-66"><a href="#cb7-66"></a>    outList =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">A =</span> outA, <span class="dt">Y =</span> outY, <span class="dt">A2 =</span> outA2, <span class="dt">Y2 =</span> outY2)</span>
<span id="cb7-67"><a href="#cb7-67"></a>  }</span>
<span id="cb7-68"><a href="#cb7-68"></a>  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(outList)</span>
<span id="cb7-69"><a href="#cb7-69"></a>}</span>
<span id="cb7-70"><a href="#cb7-70"></a>X =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="fl">0.05</span>, <span class="fl">0.35</span>, <span class="fl">0.01</span>)</span>
<span id="cb7-71"><a href="#cb7-71"></a>X =<span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.1</span><span class="op">*</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Trig">sin</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="dv">0</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(X), <span class="dt">length.out =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(X))))<span class="op">*</span>X</span>
<span id="cb7-72"><a href="#cb7-72"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(X, <span class="dt">type =</span> <span class="st">"l"</span>)</span>
<span id="cb7-73"><a href="#cb7-73"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/abline">abline</a></span>(<span class="dt">h =</span> max<span class="op">$</span>X, <span class="dt">col =</span> <span class="st">"red"</span>)</span></code></pre></div>
<p><img src="PR2AR_Primer_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>eqAR =<span class="st"> </span><span class="kw"><a href="../reference/PR2AReq.html">PR2AReq</a></span>(X, PAR, makeBdrugs)</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="co">#&gt; [1] "max A: 0.468; max X: 0.326"</span></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="co">#&gt; [1] "Non-monotonic"</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>eqAR</span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="co">#&gt; $A</span></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="co">#&gt;  [1] 0.01198213 0.01618449 0.01948225 0.02076928 0.02145081 0.02424543</span></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="co">#&gt;  [7] 0.03058186 0.03871652 0.04404433 0.04393387 0.04236533 0.04548629</span></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="co">#&gt; [13] 0.05659793 0.07270503 0.08300557 0.08007853 0.07329988 0.07630647</span></span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="co">#&gt; [19] 0.09666807 0.13284356 0.15987869 0.14836690 0.12603847 0.12705906</span></span>
<span id="cb8-10"><a href="#cb8-10"></a><span class="co">#&gt; [25] 0.17195397 0.32290314         NA         NA 0.26098140 0.24517938</span></span>
<span id="cb8-11"><a href="#cb8-11"></a><span class="co">#&gt; [31]         NA</span></span>
<span id="cb8-12"><a href="#cb8-12"></a><span class="co">#&gt; </span></span>
<span id="cb8-13"><a href="#cb8-13"></a><span class="co">#&gt; $Y</span></span>
<span id="cb8-14"><a href="#cb8-14"></a><span class="co">#&gt;            [,1]       [,2]       [,3]       [,4]       [,5]       [,6]</span></span>
<span id="cb8-15"><a href="#cb8-15"></a><span class="co">#&gt; [1,] 0.89458213 0.87765431 0.86513887 0.86042490 0.85796580 0.84814120</span></span>
<span id="cb8-16"><a href="#cb8-16"></a><span class="co">#&gt; [2,] 0.05004153 0.06509816 0.07615038 0.08029452 0.08245216 0.09104262</span></span>
<span id="cb8-17"><a href="#cb8-17"></a><span class="co">#&gt; [3,] 0.05537634 0.05724753 0.05871075 0.05928058 0.05958204 0.06081618</span></span>
<span id="cb8-18"><a href="#cb8-18"></a><span class="co">#&gt;            [,7]       [,8]       [,9]      [,10]      [,11]      [,12]</span></span>
<span id="cb8-19"><a href="#cb8-19"></a><span class="co">#&gt; [1,] 0.82729529 0.80309214 0.78859152 0.78888227 0.79305507 0.78483261</span></span>
<span id="cb8-20"><a href="#cb8-20"></a><span class="co">#&gt; [2,] 0.10910224 0.12975252 0.14194077 0.14169783 0.13820470 0.14507580</span></span>
<span id="cb8-21"><a href="#cb8-21"></a><span class="co">#&gt; [3,] 0.06360247 0.06715534 0.06946772 0.06941989 0.06874024 0.07009159</span></span>
<span id="cb8-22"><a href="#cb8-22"></a><span class="co">#&gt;           [,13]      [,14]      [,15]      [,16]      [,17]      [,18]</span></span>
<span id="cb8-23"><a href="#cb8-23"></a><span class="co">#&gt; [1,] 0.75797138 0.72458183 0.70598491 0.71107851 0.72345485 0.71786177</span></span>
<span id="cb8-24"><a href="#cb8-24"></a><span class="co">#&gt; [2,] 0.16715745 0.19370522 0.20797962 0.20411018 0.19458147 0.19890933</span></span>
<span id="cb8-25"><a href="#cb8-25"></a><span class="co">#&gt; [3,] 0.07487118 0.08171294 0.08603547 0.08481131 0.08196368 0.08322889</span></span>
<span id="cb8-26"><a href="#cb8-26"></a><span class="co">#&gt;           [,19]     [,20]     [,21]     [,22]     [,23]     [,24]</span></span>
<span id="cb8-27"><a href="#cb8-27"></a><span class="co">#&gt; [1,] 0.68397785 0.6366700 0.6087158 0.6200009 0.6445785 0.6433669</span></span>
<span id="cb8-28"><a href="#cb8-28"></a><span class="co">#&gt; [2,] 0.22431573 0.2569425 0.2742311 0.2674562 0.2517593 0.2525611</span></span>
<span id="cb8-29"><a href="#cb8-29"></a><span class="co">#&gt; [3,] 0.09170642 0.1063876 0.1170531 0.1125429 0.1036622 0.1040720</span></span>
<span id="cb8-30"><a href="#cb8-30"></a><span class="co">#&gt;          [,25]     [,26] [,27] [,28]     [,29]     [,30] [,31]</span></span>
<span id="cb8-31"><a href="#cb8-31"></a><span class="co">#&gt; [1,] 0.5977265 0.5043288    NA    NA 0.5354249 0.5446465    NA</span></span>
<span id="cb8-32"><a href="#cb8-32"></a><span class="co">#&gt; [2,] 0.2805385 0.3193380    NA    NA 0.3097963 0.3062571    NA</span></span>
<span id="cb8-33"><a href="#cb8-33"></a><span class="co">#&gt; [3,] 0.1217350 0.1763332    NA    NA 0.1547788 0.1490964    NA</span></span>
<span id="cb8-34"><a href="#cb8-34"></a><span class="co">#&gt; </span></span>
<span id="cb8-35"><a href="#cb8-35"></a><span class="co">#&gt; $A2</span></span>
<span id="cb8-36"><a href="#cb8-36"></a><span class="co">#&gt;  [1]        NA        NA        NA        NA        NA        NA        NA</span></span>
<span id="cb8-37"><a href="#cb8-37"></a><span class="co">#&gt;  [8]        NA        NA        NA        NA        NA        NA        NA</span></span>
<span id="cb8-38"><a href="#cb8-38"></a><span class="co">#&gt; [15]        NA        NA        NA        NA        NA        NA        NA</span></span>
<span id="cb8-39"><a href="#cb8-39"></a><span class="co">#&gt; [22]        NA        NA        NA        NA 0.6775987        NA        NA</span></span>
<span id="cb8-40"><a href="#cb8-40"></a><span class="co">#&gt; [29] 0.8384780 0.8925494        NA</span></span>
<span id="cb8-41"><a href="#cb8-41"></a><span class="co">#&gt; </span></span>
<span id="cb8-42"><a href="#cb8-42"></a><span class="co">#&gt; $Y2</span></span>
<span id="cb8-43"><a href="#cb8-43"></a><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13]</span></span>
<span id="cb8-44"><a href="#cb8-44"></a><span class="co">#&gt; [1,]   NA   NA   NA   NA   NA   NA   NA   NA   NA    NA    NA    NA    NA</span></span>
<span id="cb8-45"><a href="#cb8-45"></a><span class="co">#&gt; [2,]   NA   NA   NA   NA   NA   NA   NA   NA   NA    NA    NA    NA    NA</span></span>
<span id="cb8-46"><a href="#cb8-46"></a><span class="co">#&gt; [3,]   NA   NA   NA   NA   NA   NA   NA   NA   NA    NA    NA    NA    NA</span></span>
<span id="cb8-47"><a href="#cb8-47"></a><span class="co">#&gt;      [,14] [,15] [,16] [,17] [,18] [,19] [,20] [,21] [,22] [,23] [,24]</span></span>
<span id="cb8-48"><a href="#cb8-48"></a><span class="co">#&gt; [1,]    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span>
<span id="cb8-49"><a href="#cb8-49"></a><span class="co">#&gt; [2,]    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span>
<span id="cb8-50"><a href="#cb8-50"></a><span class="co">#&gt; [3,]    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span>
<span id="cb8-51"><a href="#cb8-51"></a><span class="co">#&gt;      [,25]     [,26] [,27] [,28]     [,29]     [,30] [,31]</span></span>
<span id="cb8-52"><a href="#cb8-52"></a><span class="co">#&gt; [1,]    NA 0.3993442    NA    NA 0.3696145 0.3609016    NA</span></span>
<span id="cb8-53"><a href="#cb8-53"></a><span class="co">#&gt; [2,]    NA 0.3193404    NA    NA 0.3097930 0.3062515    NA</span></span>
<span id="cb8-54"><a href="#cb8-54"></a><span class="co">#&gt; [3,]    NA 0.2813154    NA    NA 0.3205924 0.3328469    NA</span></span></code></pre></div>
<p>In the above PR2AR function we are returing the equilibrium AR associated with each <span class="math inline">\(Pf\)</span>PR value. While this is a helpful approximation, as we would expect (and demonstrated earlier) the forward simulation estimates of AR differ from the equilibrium estimates.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>makeBdrugs &lt;-<span class="st"> </span><span class="cf">function</span>(PAR) {</span>
<span id="cb9-2"><a href="#cb9-2"></a>    A =<span class="st"> </span>PAR<span class="op">$</span>A; Q =<span class="st"> </span>PAR<span class="op">$</span>Q; d =<span class="st"> </span>PAR<span class="op">$</span>d; rho =<span class="st"> </span>PAR<span class="op">$</span>rho</span>
<span id="cb9-3"><a href="#cb9-3"></a>    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>((<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>d)<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>A), (<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>d)<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>rho)<span class="op">*</span>A, d <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>d)<span class="op">*</span>rho<span class="op">*</span>A), </span>
<span id="cb9-4"><a href="#cb9-4"></a>          <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>((<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>d)<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>A<span class="op">*</span>rho)<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>Q), (<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>d)<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>A<span class="op">*</span>rho)<span class="op">*</span>Q, d <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>d)<span class="op">*</span>rho<span class="op">*</span>A),</span>
<span id="cb9-5"><a href="#cb9-5"></a>          <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>d, <span class="dv">0</span>, d))</span>
<span id="cb9-6"><a href="#cb9-6"></a>}</span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="co"># Generate W and V matrices</span></span>
<span id="cb9-8"><a href="#cb9-8"></a>makeWdrugs &lt;-<span class="st"> </span><span class="cf">function</span>(PAR) {</span>
<span id="cb9-9"><a href="#cb9-9"></a>    A =<span class="st"> </span>PAR<span class="op">$</span>A; Q =<span class="st"> </span>PAR<span class="op">$</span>Q; d =<span class="st"> </span>PAR<span class="op">$</span>d; rho =<span class="st"> </span>PAR<span class="op">$</span>rho</span>
<span id="cb9-10"><a href="#cb9-10"></a>    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="op">-</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>d), (<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>d)<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>rho), (<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>d)<span class="op">*</span>rho), </span>
<span id="cb9-11"><a href="#cb9-11"></a>          <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="op">-</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>d)<span class="op">*</span>rho<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>Q), <span class="op">-</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>d)<span class="op">*</span>rho<span class="op">*</span>Q, (<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>d)<span class="op">*</span>rho),</span>
<span id="cb9-12"><a href="#cb9-12"></a>          <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb9-13"><a href="#cb9-13"></a>}</span>
<span id="cb9-14"><a href="#cb9-14"></a>W =<span class="st"> </span><span class="kw">makeWdrugs</span>(PAR)</span>
<span id="cb9-15"><a href="#cb9-15"></a>makeVdrugs &lt;-<span class="st"> </span><span class="cf">function</span>(PAR) {</span>
<span id="cb9-16"><a href="#cb9-16"></a>    PAR<span class="op">$</span>A =<span class="st"> </span><span class="dv">0</span></span>
<span id="cb9-17"><a href="#cb9-17"></a>    <span class="kw"><a href="../reference/makeBdrugs.html">makeBdrugs</a></span>(PAR)</span>
<span id="cb9-18"><a href="#cb9-18"></a>}</span>
<span id="cb9-19"><a href="#cb9-19"></a>V =<span class="st"> </span><span class="kw">makeVdrugs</span>(PAR)</span>
<span id="cb9-20"><a href="#cb9-20"></a></span>
<span id="cb9-21"><a href="#cb9-21"></a>D=<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/t">t</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb9-22"><a href="#cb9-22"></a></span>
<span id="cb9-23"><a href="#cb9-23"></a><span class="co"># Set up equilibrium start values</span></span>
<span id="cb9-24"><a href="#cb9-24"></a>forwardA =<span class="st"> </span>PAR<span class="op">$</span>A =<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(eqAR<span class="op">$</span>A[<span class="dv">1</span>])</span>
<span id="cb9-25"><a href="#cb9-25"></a>Y =<span class="st"> </span><span class="kw"><a href="../reference/findYeq.html">findYeq</a></span>(PAR, makeBdrugs)</span>
<span id="cb9-26"><a href="#cb9-26"></a><span class="co"># Simulate forward</span></span>
<span id="cb9-27"><a href="#cb9-27"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(X)) {</span>
<span id="cb9-28"><a href="#cb9-28"></a>    forwardA[i] =<span class="st"> </span>PAR<span class="op">$</span>A =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>((X[i] <span class="op">-</span><span class="st"> </span>D<span class="op">%*%</span>V<span class="op">%*%</span>Y) <span class="op">/</span><span class="st"> </span>(D<span class="op">%*%</span>W<span class="op">%*%</span>Y))</span>
<span id="cb9-29"><a href="#cb9-29"></a>    B =<span class="st"> </span><span class="kw"><a href="../reference/makeBdrugs.html">makeBdrugs</a></span>(PAR)</span>
<span id="cb9-30"><a href="#cb9-30"></a>    Y =<span class="st"> </span>B<span class="op">%*%</span>Y</span>
<span id="cb9-31"><a href="#cb9-31"></a>}</span>
<span id="cb9-32"><a href="#cb9-32"></a></span>
<span id="cb9-33"><a href="#cb9-33"></a><span class="co"># Plot</span></span>
<span id="cb9-34"><a href="#cb9-34"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(eqAR<span class="op">$</span>A, <span class="dt">type =</span> <span class="st">"l"</span>, <span class="dt">ylab =</span> <span class="st">"A"</span>, </span>
<span id="cb9-35"><a href="#cb9-35"></a>     <span class="dt">ylim =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(eqAR<span class="op">$</span>A, forwardA), <span class="dt">na.rm =</span> T)))</span>
<span id="cb9-36"><a href="#cb9-36"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/abline">abline</a></span>(<span class="dt">h =</span> max<span class="op">$</span>A, <span class="dt">col =</span> <span class="st">"red"</span>)</span>
<span id="cb9-37"><a href="#cb9-37"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(forwardA, <span class="dt">lty =</span> <span class="st">"dashed"</span>)</span>
<span id="cb9-38"><a href="#cb9-38"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/legend">legend</a></span>(<span class="st">"topleft"</span>, <span class="dt">legend =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"Steady"</span>, <span class="st">"Forward"</span>), <span class="dt">lty =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)</span></code></pre></div>
<p><img src="PR2AR_Primer_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>Having worked through all that, we jump to a much harder model tracking the age of infection with the possibility of superinfection.</p>
</div>
<div id="age-of-infection-aoi-and-overwriting-superinfection" class="section level2">
<h2 class="hasAnchor">
<a href="#age-of-infection-aoi-and-overwriting-superinfection" class="anchor"></a>Age of Infection (AoI) and Overwriting Superinfection</h2>
<p>We keep most of the notation from before, but now let <span class="math inline">\(I_{i,t}\)</span> denote the fraction of the population that has had its most recent infection <span class="math inline">\(i\)</span> months ago, and <span class="math inline">\(E_{i,t}\)</span> denote the fraction of the population that was just exposed and whose previous infection occurred <span class="math inline">\(i\)</span> months ago: <span class="math display">\[\begin{equation} \begin{array}{rl}
S_{t+1} &amp; = (1-A_t) S_t  + \sum_i (1-A_t)(1-Q_i) I_{i,t}  \\ 
E_{0, t+1} &amp;=  A_t \left[ S_t + \sum_i (1-Q_i)I_{i,t} \right] \\ 
E_{1,t+1} &amp;=   A_t \left[E_{0,t} + \sum_{i=1}^n E_{i,t}) \right] \\ 
E_{i,t+1} &amp;=   A_t Q_{i-1} I_{i-1,t} \\
E_{n,t+1} &amp;=   A_t \left( Q_{n-1, t} I_{n-1,t} +  Q_{n, t} I_{n,t} \right) \\ 
I_{1,t+1} &amp;=   (1-A_t) \sum_{i=1}^n  E_{i,t}\\ 
I_{i,t+1} &amp;=   (1-A_t) Q_{i-1, t} I_{i-1,t} \\ 
I_{n,t+1} &amp;=   (1-A_t) \left( Q_{n-1, t} I_{n-1,t} +  Q_{n, t} I_{n,t} \right) \\ 
\end{array} \end{equation}\]</span> …so we write <span class="math display">\[ Y = \left&lt;S, E_0, E_i, \ldots, E_{n-1}, E_n, I_1, I_i, \ldots, I_{n-1}, I_n \right&gt; \]</span> and <span class="math display">\[ D = \left&lt;0, 0, 1, \ldots, 1\right&gt; \]</span></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>PAR<span class="op">$</span>In &lt;-<span class="st"> </span><span class="dv">5</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>PAR<span class="op">$</span>Cn &lt;-<span class="st"> </span><span class="dv">0</span></span>
<span id="cb10-3"><a href="#cb10-3"></a>makeD &lt;-<span class="st"> </span><span class="cf">function</span>(PAR) {</span>
<span id="cb10-4"><a href="#cb10-4"></a>  In =<span class="st"> </span>PAR<span class="op">$</span>In; Cn =<span class="st"> </span>PAR<span class="op">$</span>Cn</span>
<span id="cb10-5"><a href="#cb10-5"></a>  D =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>)</span>
<span id="cb10-6"><a href="#cb10-6"></a>  <span class="cf">if</span>(In <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) {</span>
<span id="cb10-7"><a href="#cb10-7"></a>    D =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(D, <span class="dv">0</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">1</span>, In<span class="op">*</span><span class="dv">2</span>))</span>
<span id="cb10-8"><a href="#cb10-8"></a>  } <span class="cf">else</span> {</span>
<span id="cb10-9"><a href="#cb10-9"></a>    D =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(D, <span class="dv">1</span>)</span>
<span id="cb10-10"><a href="#cb10-10"></a>  }</span>
<span id="cb10-11"><a href="#cb10-11"></a>  D =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(D, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, Cn))</span>
<span id="cb10-12"><a href="#cb10-12"></a>  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(D)</span>
<span id="cb10-13"><a href="#cb10-13"></a>}</span>
<span id="cb10-14"><a href="#cb10-14"></a><span class="kw"><a href="../reference/makeD.html">makeD</a></span>(PAR)</span>
<span id="cb10-15"><a href="#cb10-15"></a><span class="co">#&gt;  [1] 0 0 1 1 1 1 1 1 1 1 1 1</span></span>
<span id="cb10-16"><a href="#cb10-16"></a></span>
<span id="cb10-17"><a href="#cb10-17"></a>makeBage &lt;-<span class="st"> </span><span class="cf">function</span>(PAR) {</span>
<span id="cb10-18"><a href="#cb10-18"></a>  A =<span class="st"> </span>PAR<span class="op">$</span>A; Q =<span class="st"> </span>PAR<span class="op">$</span>Q; In =<span class="st"> </span>PAR<span class="op">$</span>In</span>
<span id="cb10-19"><a href="#cb10-19"></a>  S =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dt">S=</span><span class="dv">1</span><span class="op">-</span>A, <span class="dt">E0=</span>A, <span class="dt">E=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, In), <span class="dt">I =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>,In))</span>
<span id="cb10-20"><a href="#cb10-20"></a>  E0 =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="dv">0</span>, A, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, In<span class="dv">-1</span>), (<span class="dv">1</span><span class="op">-</span>A), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, In<span class="dv">-1</span>))</span>
<span id="cb10-21"><a href="#cb10-21"></a>  M =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(S, E0)</span>
<span id="cb10-22"><a href="#cb10-22"></a>  </span>
<span id="cb10-23"><a href="#cb10-23"></a>  Ei =<span class="st"> </span>E0</span>
<span id="cb10-24"><a href="#cb10-24"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>In) M =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(M, Ei)</span>
<span id="cb10-25"><a href="#cb10-25"></a>  </span>
<span id="cb10-26"><a href="#cb10-26"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>(In<span class="dv">-1</span>)){</span>
<span id="cb10-27"><a href="#cb10-27"></a>    Ii=<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>((<span class="dv">1</span><span class="op">-</span>A)<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>Q), A<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>Q), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>,i), A<span class="op">*</span>Q, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, In<span class="op">-</span>i<span class="dv">-1</span>), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>,i), (<span class="dv">1</span><span class="op">-</span>A)<span class="op">*</span>Q, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, In<span class="op">-</span>i<span class="dv">-1</span>))</span>
<span id="cb10-28"><a href="#cb10-28"></a>    M =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(M, Ii)</span>
<span id="cb10-29"><a href="#cb10-29"></a>  }</span>
<span id="cb10-30"><a href="#cb10-30"></a>  </span>
<span id="cb10-31"><a href="#cb10-31"></a>  Im=<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>( (<span class="dv">1</span><span class="op">-</span>A)<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>Q), A<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>Q), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>,In<span class="dv">-1</span>), A<span class="op">*</span>Q,  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>,In<span class="dv">-1</span>), (<span class="dv">1</span><span class="op">-</span>A)<span class="op">*</span>Q)</span>
<span id="cb10-32"><a href="#cb10-32"></a>  M =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(M, Im)</span>
<span id="cb10-33"><a href="#cb10-33"></a>  </span>
<span id="cb10-34"><a href="#cb10-34"></a>  M</span>
<span id="cb10-35"><a href="#cb10-35"></a>}</span>
<span id="cb10-36"><a href="#cb10-36"></a>B =<span class="st"> </span><span class="kw"><a href="../reference/makeBage.html">makeBage</a></span>(PAR)</span>
<span id="cb10-37"><a href="#cb10-37"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colSums">colSums</a></span>(B)</span>
<span id="cb10-38"><a href="#cb10-38"></a><span class="co">#&gt;  S E0 Ei Ei Ei Ei Ei Ii Ii Ii Ii Im </span></span>
<span id="cb10-39"><a href="#cb10-39"></a><span class="co">#&gt;  1  1  1  1  1  1  1  1  1  1  1  1</span></span>
<span id="cb10-40"><a href="#cb10-40"></a></span>
<span id="cb10-41"><a href="#cb10-41"></a>makeVage &lt;-<span class="st"> </span><span class="cf">function</span>(PAR) {</span>
<span id="cb10-42"><a href="#cb10-42"></a>  PAR<span class="op">$</span>A=<span class="dv">0</span></span>
<span id="cb10-43"><a href="#cb10-43"></a>  <span class="kw"><a href="../reference/makeBage.html">makeBage</a></span>(PAR)</span>
<span id="cb10-44"><a href="#cb10-44"></a>}</span>
<span id="cb10-45"><a href="#cb10-45"></a>V =<span class="st"> </span><span class="kw">makeVage</span>(PAR)</span>
<span id="cb10-46"><a href="#cb10-46"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colSums">colSums</a></span>(V)</span>
<span id="cb10-47"><a href="#cb10-47"></a><span class="co">#&gt;  S E0 Ei Ei Ei Ei Ei Ii Ii Ii Ii Im </span></span>
<span id="cb10-48"><a href="#cb10-48"></a><span class="co">#&gt;  1  1  1  1  1  1  1  1  1  1  1  1</span></span>
<span id="cb10-49"><a href="#cb10-49"></a></span>
<span id="cb10-50"><a href="#cb10-50"></a>makeWage &lt;-<span class="st"> </span><span class="cf">function</span>(PAR){</span>
<span id="cb10-51"><a href="#cb10-51"></a>  (<span class="kw"><a href="../reference/makeBage.html">makeBage</a></span>(PAR)<span class="op">-</span><span class="kw">makeVage</span>(PAR))<span class="op">/</span>PAR<span class="op">$</span>A</span>
<span id="cb10-52"><a href="#cb10-52"></a>}</span>
<span id="cb10-53"><a href="#cb10-53"></a>W =<span class="st"> </span><span class="kw">makeWage</span>(PAR)</span>
<span id="cb10-54"><a href="#cb10-54"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colSums">colSums</a></span>(W)</span>
<span id="cb10-55"><a href="#cb10-55"></a><span class="co">#&gt;            S           E0           Ei           Ei           Ei </span></span>
<span id="cb10-56"><a href="#cb10-56"></a><span class="co">#&gt; 1.110223e-16 1.110223e-16 1.110223e-16 1.110223e-16 1.110223e-16 </span></span>
<span id="cb10-57"><a href="#cb10-57"></a><span class="co">#&gt;           Ei           Ei           Ii           Ii           Ii </span></span>
<span id="cb10-58"><a href="#cb10-58"></a><span class="co">#&gt; 1.110223e-16 1.110223e-16 6.938894e-18 6.938894e-18 6.938894e-18 </span></span>
<span id="cb10-59"><a href="#cb10-59"></a><span class="co">#&gt;           Ii           Im </span></span>
<span id="cb10-60"><a href="#cb10-60"></a><span class="co">#&gt; 6.938894e-18 6.938894e-18</span></span>
<span id="cb10-61"><a href="#cb10-61"></a></span>
<span id="cb10-62"><a href="#cb10-62"></a><span class="co"># Update AR2PR to accomodate exposure and treatment class</span></span>
<span id="cb10-63"><a href="#cb10-63"></a>AR2PR &lt;-<span class="st"> </span><span class="cf">function</span>(A, PAR, Bfn, <span class="dt">eigen =</span> T) {</span>
<span id="cb10-64"><a href="#cb10-64"></a>    D =<span class="st"> </span><span class="kw"><a href="../reference/makeD.html">makeD</a></span>(PAR)</span>
<span id="cb10-65"><a href="#cb10-65"></a>    PR =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>()</span>
<span id="cb10-66"><a href="#cb10-66"></a>    <span class="cf">for</span>(Ai <span class="cf">in</span> A) {</span>
<span id="cb10-67"><a href="#cb10-67"></a>        PAR<span class="op">$</span>A =<span class="st"> </span>Ai</span>
<span id="cb10-68"><a href="#cb10-68"></a>        <span class="cf">if</span>(eigen) {</span>
<span id="cb10-69"><a href="#cb10-69"></a>            eq =<span class="st"> </span><span class="kw"><a href="../reference/findYeq.html">findYeq</a></span>(PAR, Bfn)</span>
<span id="cb10-70"><a href="#cb10-70"></a>        } <span class="cf">else</span> {</span>
<span id="cb10-71"><a href="#cb10-71"></a>            eq =<span class="st"> </span><span class="kw">algebYeq</span>(PAR)</span>
<span id="cb10-72"><a href="#cb10-72"></a>        }</span>
<span id="cb10-73"><a href="#cb10-73"></a>        PR =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(PR, D<span class="op">%*%</span>eq)</span>
<span id="cb10-74"><a href="#cb10-74"></a>        <span class="cf">if</span>(PAR<span class="op">$</span>Cn <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) {</span>
<span id="cb10-75"><a href="#cb10-75"></a>            Ci =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(eq[(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(eq) <span class="op">-</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>PAR<span class="op">$</span>Cn) <span class="op">+</span><span class="st"> </span><span class="dv">1</span>])</span>
<span id="cb10-76"><a href="#cb10-76"></a>            <span class="cf">if</span>(Ai <span class="op">==</span><span class="st"> </span>A[<span class="dv">1</span>]) {</span>
<span id="cb10-77"><a href="#cb10-77"></a>                C =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(Ci)</span>
<span id="cb10-78"><a href="#cb10-78"></a>            } <span class="cf">else</span> {</span>
<span id="cb10-79"><a href="#cb10-79"></a>                C =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(C, Ci)</span>
<span id="cb10-80"><a href="#cb10-80"></a>            }</span>
<span id="cb10-81"><a href="#cb10-81"></a>        }</span>
<span id="cb10-82"><a href="#cb10-82"></a>    }</span>
<span id="cb10-83"><a href="#cb10-83"></a>    <span class="cf">if</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(eq) <span class="op">==</span><span class="st"> </span><span class="dv">3</span>) {</span>
<span id="cb10-84"><a href="#cb10-84"></a>        out.list =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">X =</span> PR, <span class="dt">C =</span> C)</span>
<span id="cb10-85"><a href="#cb10-85"></a>    } <span class="cf">else</span> {</span>
<span id="cb10-86"><a href="#cb10-86"></a>        out.list =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">X =</span> PR)</span>
<span id="cb10-87"><a href="#cb10-87"></a>    }</span>
<span id="cb10-88"><a href="#cb10-88"></a>    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(out.list)</span>
<span id="cb10-89"><a href="#cb10-89"></a>}</span>
<span id="cb10-90"><a href="#cb10-90"></a></span>
<span id="cb10-91"><a href="#cb10-91"></a><span class="kw"><a href="../reference/findAXmax.html">findAXmax</a></span>(PAR, makeBage)</span>
<span id="cb10-92"><a href="#cb10-92"></a><span class="co">#&gt; $A</span></span>
<span id="cb10-93"><a href="#cb10-93"></a><span class="co">#&gt; [1] 0.9999323</span></span>
<span id="cb10-94"><a href="#cb10-94"></a><span class="co">#&gt; </span></span>
<span id="cb10-95"><a href="#cb10-95"></a><span class="co">#&gt; $X</span></span>
<span id="cb10-96"><a href="#cb10-96"></a><span class="co">#&gt; [1] 0.9999967</span></span>
<span id="cb10-97"><a href="#cb10-97"></a></span>
<span id="cb10-98"><a href="#cb10-98"></a>X =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="fl">0.5</span>, <span class="fl">0.8</span>, <span class="fl">0.01</span>)</span>
<span id="cb10-99"><a href="#cb10-99"></a>X =<span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.1</span><span class="op">*</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Trig">sin</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="dv">0</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(X), <span class="dt">length.out =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(X))))<span class="op">*</span>X</span>
<span id="cb10-100"><a href="#cb10-100"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(X, <span class="dt">type =</span> <span class="st">"l"</span>)</span></code></pre></div>
<p><img src="PR2AR_Primer_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a></span>
<span id="cb11-2"><a href="#cb11-2"></a>eqAR =<span class="st"> </span><span class="kw"><a href="../reference/PR2AReq.html">PR2AReq</a></span>(X, PAR, makeBage)</span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="co">#&gt; [1] "max A: 1; max X: 1"</span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="co">#&gt; [1] "Monotonic"</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(eqAR<span class="op">$</span>A, <span class="dt">type =</span> <span class="st">"l"</span>)</span></code></pre></div>
<p><img src="PR2AR_Primer_files/figure-html/unnamed-chunk-6-2.png" width="700"></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a></span>
<span id="cb12-2"><a href="#cb12-2"></a>PAR<span class="op">$</span>A =<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(eqAR<span class="op">$</span>A[<span class="dv">1</span>])</span>
<span id="cb12-3"><a href="#cb12-3"></a>Y =<span class="st"> </span><span class="kw"><a href="../reference/findYeq.html">findYeq</a></span>(PAR, makeBage)</span>
<span id="cb12-4"><a href="#cb12-4"></a>D =<span class="st"> </span><span class="kw"><a href="../reference/makeD.html">makeD</a></span>(PAR)</span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>((X[i] <span class="op">-</span><span class="st"> </span>D<span class="op">%*%</span>V<span class="op">%*%</span>Y) <span class="op">/</span><span class="st"> </span>(D<span class="op">%*%</span>W<span class="op">%*%</span>Y))</span>
<span id="cb12-6"><a href="#cb12-6"></a><span class="co">#&gt; [1] 5.187568e+16</span></span>
<span id="cb12-7"><a href="#cb12-7"></a></span>
<span id="cb12-8"><a href="#cb12-8"></a>D<span class="op">%*%</span>W<span class="op">%*%</span>Y</span>
<span id="cb12-9"><a href="#cb12-9"></a><span class="co">#&gt;              [,1]</span></span>
<span id="cb12-10"><a href="#cb12-10"></a><span class="co">#&gt; [1,] 5.161384e-18</span></span></code></pre></div>
</div>
<div id="aoi-forward-simulation" class="section level2">
<h2 class="hasAnchor">
<a href="#aoi-forward-simulation" class="anchor"></a>AoI Forward Simulation</h2>
<p>Forward simulation with the initial <span class="math inline">\(A_t\)</span> formula breaks down because there is a one timestep delay in the impact of <span class="math inline">\(A\)</span> on <span class="math inline">\(X\)</span>, so that <span class="math inline">\(D \cdot W \cdot Y_t = 0\)</span>. We reformulate <span class="math inline">\(A_t\)</span> as a function of <span class="math inline">\(X_{t+2}\)</span>;</p>
<p><span class="math display">\[D Y_{t+2} = X_{t+2} = D B_{t+1} B_{t} Y_t = D(A_{t+1}W + V)(A_t W + V) Y_t = D(A_t A_{t+1} W^2 + A_{t+1} W V + A_t V W + V^2) Y_t\]</span></p>
<p>Because the row sums of <span class="math inline">\(W\)</span> are zero, the terms <span class="math inline">\(A_t A_{t+1} W^2\)</span> and <span class="math inline">\(A_{t+1} W V\)</span> drop out and we get,</p>
<p><span class="math display">\[ A_t = \frac{X_{t+2} - D V^2 Y_t}  {D V W Y_t}\]</span></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="co">## Update </span></span>
<span id="cb13-2"><a href="#cb13-2"></a>fn2 &lt;-<span class="st"> </span><span class="cf">function</span>(params, PAR, Bfn, X) {</span>
<span id="cb13-3"><a href="#cb13-3"></a>  A1 =<span class="st"> </span>params[<span class="dv">1</span>]</span>
<span id="cb13-4"><a href="#cb13-4"></a>  A2 =<span class="st"> </span>params[<span class="dv">2</span>]</span>
<span id="cb13-5"><a href="#cb13-5"></a>  D =<span class="st"> </span><span class="kw"><a href="../reference/makeD.html">makeD</a></span>(PAR)</span>
<span id="cb13-6"><a href="#cb13-6"></a>  PAR<span class="op">$</span>A =<span class="st"> </span>A1</span>
<span id="cb13-7"><a href="#cb13-7"></a>  Y0 =<span class="st"> </span><span class="kw"><a href="../reference/findYeq.html">findYeq</a></span>(PAR, Bfn)</span>
<span id="cb13-8"><a href="#cb13-8"></a>  PAR<span class="op">$</span>A =<span class="st"> </span>A2</span>
<span id="cb13-9"><a href="#cb13-9"></a>  B2 =<span class="st"> </span><span class="kw">Bfn</span>(PAR)</span>
<span id="cb13-10"><a href="#cb13-10"></a>  Y1 =<span class="st"> </span>B2<span class="op">%*%</span>Y0</span>
<span id="cb13-11"><a href="#cb13-11"></a>  Y2 =<span class="st"> </span>B2<span class="op">%*%</span>Y1</span>
<span id="cb13-12"><a href="#cb13-12"></a>  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">abs</a></span>(X[<span class="dv">1</span>] <span class="op">-</span><span class="st"> </span>D<span class="op">%*%</span>Y1)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">abs</a></span>(X[<span class="dv">2</span>] <span class="op">-</span><span class="st"> </span>D<span class="op">%*%</span>Y2))))</span>
<span id="cb13-13"><a href="#cb13-13"></a>}</span>
<span id="cb13-14"><a href="#cb13-14"></a></span>
<span id="cb13-15"><a href="#cb13-15"></a>params =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/optim">optim</a></span>(<span class="dt">fn =</span> fn2, <span class="dt">par =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="fl">0.1</span>), <span class="dt">PAR =</span> PAR, <span class="dt">Bfn =</span> makeBage, <span class="dt">X =</span> X)<span class="op">$</span>par</span>
<span id="cb13-16"><a href="#cb13-16"></a></span>
<span id="cb13-17"><a href="#cb13-17"></a><span class="co"># Set up equilibrium start values</span></span>
<span id="cb13-18"><a href="#cb13-18"></a>forwardA =<span class="st"> </span>PAR<span class="op">$</span>A =<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(params[<span class="dv">1</span>])</span>
<span id="cb13-19"><a href="#cb13-19"></a>Y0 =<span class="st"> </span><span class="kw"><a href="../reference/findYeq.html">findYeq</a></span>(PAR, makeBage)</span>
<span id="cb13-20"><a href="#cb13-20"></a>forwardA[<span class="dv">2</span>] =<span class="st"> </span>PAR<span class="op">$</span>A =<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(params[<span class="dv">2</span>])</span>
<span id="cb13-21"><a href="#cb13-21"></a>B =<span class="st"> </span><span class="kw"><a href="../reference/makeBage.html">makeBage</a></span>(PAR)</span>
<span id="cb13-22"><a href="#cb13-22"></a>Y =<span class="st"> </span>B<span class="op">%*%</span>Y0</span>
<span id="cb13-23"><a href="#cb13-23"></a></span>
<span id="cb13-24"><a href="#cb13-24"></a><span class="co"># Check against input X</span></span>
<span id="cb13-25"><a href="#cb13-25"></a>D =<span class="st"> </span><span class="kw"><a href="../reference/makeD.html">makeD</a></span>(PAR)</span>
<span id="cb13-26"><a href="#cb13-26"></a>X[<span class="dv">1</span>]</span>
<span id="cb13-27"><a href="#cb13-27"></a><span class="co">#&gt; [1] 0.5</span></span>
<span id="cb13-28"><a href="#cb13-28"></a>D<span class="op">%*%</span>Y</span>
<span id="cb13-29"><a href="#cb13-29"></a><span class="co">#&gt;      [,1]</span></span>
<span id="cb13-30"><a href="#cb13-30"></a><span class="co">#&gt; [1,]  0.5</span></span>
<span id="cb13-31"><a href="#cb13-31"></a>forwardX =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(D<span class="op">%*%</span>Y)</span>
<span id="cb13-32"><a href="#cb13-32"></a></span>
<span id="cb13-33"><a href="#cb13-33"></a><span class="co"># Simulate forward</span></span>
<span id="cb13-34"><a href="#cb13-34"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">3</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(X)) {</span>
<span id="cb13-35"><a href="#cb13-35"></a>    forwardA[i] =<span class="st"> </span>PAR<span class="op">$</span>A =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>((X[i] <span class="op">-</span><span class="st"> </span>D<span class="op">%*%</span>V<span class="op">%*%</span>V<span class="op">%*%</span>Y) <span class="op">/</span><span class="st"> </span>(D<span class="op">%*%</span>V<span class="op">%*%</span>W<span class="op">%*%</span>Y))</span>
<span id="cb13-36"><a href="#cb13-36"></a>    B =<span class="st"> </span><span class="kw"><a href="../reference/makeBage.html">makeBage</a></span>(PAR)</span>
<span id="cb13-37"><a href="#cb13-37"></a>    Y =<span class="st"> </span>B<span class="op">%*%</span>Y</span>
<span id="cb13-38"><a href="#cb13-38"></a>    forwardX =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(forwardX, D<span class="op">%*%</span>Y)</span>
<span id="cb13-39"><a href="#cb13-39"></a>}</span>
<span id="cb13-40"><a href="#cb13-40"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">abs</a></span>(X[<span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(forwardX)] <span class="op">-</span><span class="st"> </span>forwardX))</span>
<span id="cb13-41"><a href="#cb13-41"></a><span class="co">#&gt; [1] 1.147394e-08</span></span>
<span id="cb13-42"><a href="#cb13-42"></a></span>
<span id="cb13-43"><a href="#cb13-43"></a><span class="co"># Plot</span></span>
<span id="cb13-44"><a href="#cb13-44"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(eqAR<span class="op">$</span>A, <span class="dt">type =</span> <span class="st">"l"</span>, <span class="dt">ylab =</span> <span class="st">"A"</span>, </span>
<span id="cb13-45"><a href="#cb13-45"></a>     <span class="dt">ylim =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(eqAR<span class="op">$</span>A, forwardA)), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(eqAR<span class="op">$</span>A, forwardA), <span class="dt">na.rm =</span> T)))</span>
<span id="cb13-46"><a href="#cb13-46"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/abline">abline</a></span>(<span class="dt">h =</span> max<span class="op">$</span>X, <span class="dt">col =</span> <span class="st">"red"</span>)</span>
<span id="cb13-47"><a href="#cb13-47"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(forwardA, <span class="dt">lty =</span> <span class="st">"dashed"</span>)</span>
<span id="cb13-48"><a href="#cb13-48"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/legend">legend</a></span>(<span class="st">"topleft"</span>, <span class="dt">legend =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"Steady"</span>, <span class="st">"Forward"</span>), <span class="dt">lty =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)</span></code></pre></div>
<p><img src="PR2AR_Primer_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
</div>
<div id="combine-aoi-with-overwriting-superinfection-and-drugs" class="section level2">
<h2 class="hasAnchor">
<a href="#combine-aoi-with-overwriting-superinfection-and-drugs" class="anchor"></a>Combine AoI with Overwriting Superinfection and Drugs</h2>
<p><span class="math display">\[\begin{equation} \begin{array}{rl}
S_{t+1} &amp; = \left( 1 -\delta \right) \left[ (1-A_t) S_t  + \sum_i (1-A_t)(1-P_i) I_{i,t} +  C_{2,t}\right]  \\ 
E_{0, t+1} &amp;= \left( 1 -\delta \right) A_t \left[ S_t + \sum_i (1-P_i)(1-\rho_i)I_{i,t} \right] \\ 
E_{1,t+1} &amp;=  \left( 1 -\delta \right) A_t \left[E_{0,t} + \sum_{i=1}^n (1-\rho_i) E_{i,t}) \right] \\ 
E_{i,t+1} &amp;=  \left( 1 -\delta \right) A_t P_{i-1} I_{i-1,t} \\
E_{n,t+1} &amp;=  \left( 1 -\delta \right) A_t P_{i-1} (I_{n-1,t} + I_{n,t}) \\
I_{1,t+1} &amp;=  \left( 1 -\delta \right) (1-A_t) \sum_{i=1}^n (1-\rho_i) E_{i,t}\\ 
I_{i,t+1} &amp;=  \left( 1 -\delta \right) (1-A_t) P_{i-1, t} I_{i-1,t} \\ 
I_{n,t+1} &amp;=  \left( 1 -\delta \right) (1-A_t) \left( P_{n-1, t} I_{n-1,t} +  P_{n, t} I_{n,t} \right) \\ 
C_{1,t+1} &amp; = (1-\delta) \sum_i \left( \rho_i E_{i, t} + A_t \rho_i I_{i, t}\right)  + \delta \\ 
C_{2,t+1} &amp; = (1-\delta) C_{1,t} \\ 
\end{array} \end{equation}\]</span> …so we write <span class="math display">\[ Y = \left[S, E_0, E_i, \ldots, E_{n-1}, E_n, I_1, I_i, \ldots, I_{n-1}, I_n, C_1, C_2 \right] \]</span> And we can write the previous equations as: <span class="math display">\[ Y_{t+1} = (1-\delta) \left[ A_t W Y_t + V Y_t \right]\]</span> where <span class="math inline">\(W=\)</span> <span class="math display">\[(1-\delta) \left[ \begin{array}{c||c|cc|cccc|cc}
&amp;S&amp;E_0&amp;E_i&amp;I_1&amp;I_i&amp;I_m&amp;I_n&amp;C1&amp;C2\\ \hline \hline
S&amp;-1&amp;0&amp;0&amp;-(1-P_1)&amp;-(1-P_2)&amp;-(1-P_m)&amp;-(1-P_n)&amp;0&amp;0\\
E_0&amp;1&amp;0&amp;0&amp;(1-P_1)(1-\rho_1)&amp;(1-P_i)(1-\rho_i)&amp;(1-P_m)(1-\rho_m)&amp;(1-P_n)(1-\rho_n)&amp;0&amp;0\\
E_1&amp;0&amp;1&amp;(1-\rho_i)&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0\\
E_2&amp;0&amp;0&amp;0&amp;P_1(1-\rho_1)&amp;0&amp;0&amp;0&amp;0&amp;0\\
E_3&amp;0&amp;0&amp;0&amp;0&amp;P_2 (1-\rho_2)&amp;0&amp;0&amp;0&amp;0\\
E_n&amp;0&amp;0&amp;0&amp;0&amp;0&amp;P_m (1-\rho_m)&amp;P_n  (1-\rho_n)&amp;0&amp;0\\
I_1&amp;0&amp;-1&amp;-(1-\rho_i)&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0\\
I_2&amp;0&amp;0&amp;0&amp;-P_1&amp;0&amp;0&amp;0&amp;0&amp;0\\
I_3&amp;0&amp;0&amp;0&amp;0&amp;-P_2&amp;0&amp;0&amp;0&amp;0\\
I_n&amp;0&amp;0&amp;0&amp;0&amp;0&amp;-P_m&amp;-P_n&amp;0&amp;0\\
C1&amp;0&amp;0&amp;0&amp;\rho_1&amp;\rho_2&amp;\rho_m&amp;\rho_n&amp;0&amp;0\\
C2&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0\\
\end{array} \right]\]</span></p>
<p><span class="math inline">\(V=\)</span> <span class="math display">\[(1-\delta) \left[ \begin{array}{c||c|cccc|cccc|cc}
&amp;S&amp;E_0&amp;E_1&amp;E_2&amp;E_n&amp;I_1&amp;I_2&amp;I_m&amp;I_n&amp;C_1&amp;C_2 \\ \hline \hline
S&amp;1&amp;0&amp;0&amp;0&amp;0&amp;1-P_1&amp;1-P_2&amp;1-P_m&amp;1-P_n&amp;0&amp;1\\ \hline
E_0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0 \\
E_1&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0 \\
E_2&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0 \\
E_3&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0 \\
E_n&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0 \\ \hline
I_1&amp;0&amp;1&amp;1-\rho_1&amp;1-\rho_2&amp;1-\rho_n&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0 \\
I_2&amp;0&amp;0&amp;0&amp;0&amp;0&amp;P_1&amp;0&amp;0&amp;0&amp;0&amp;0 \\
I_3&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;P_2&amp;0&amp;0&amp;0&amp;0 \\
I_n&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;P_m&amp;P_n&amp;0&amp;0 \\ \hline
C_1&amp;0&amp;0&amp;\rho_1&amp;\rho_2&amp;\rho_n&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0\ \\
C_2&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0&amp;1&amp;0\\
\end{array} \right] + \left[
 \begin{array}{c} 0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\\delta/(1-\delta)\\0  \end{array} \right]\]</span></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a></span>
<span id="cb14-2"><a href="#cb14-2"></a>makeBdrugs_age =<span class="st"> </span><span class="cf">function</span>(PAR){</span>
<span id="cb14-3"><a href="#cb14-3"></a>  A =<span class="st"> </span>PAR<span class="op">$</span>A; Q =<span class="st"> </span>PAR<span class="op">$</span>Q; rho =<span class="st"> </span>PAR<span class="op">$</span>rho; In =<span class="st"> </span>PAR<span class="op">$</span>In; Cn =<span class="st"> </span>PAR<span class="op">$</span>Cn</span>
<span id="cb14-4"><a href="#cb14-4"></a>  S =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dt">S=</span><span class="dv">1</span><span class="op">-</span>A, <span class="dt">E0=</span>A, <span class="dt">E=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, In), <span class="dt">I =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>,In), <span class="dt">C=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>,Cn))</span>
<span id="cb14-5"><a href="#cb14-5"></a>  E0 =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="dv">0</span>, (<span class="dv">1</span><span class="op">-</span>rho)<span class="op">*</span>A, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, In<span class="dv">-1</span>), (<span class="dv">1</span><span class="op">-</span>rho)<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>A), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, In<span class="dv">-1</span>), rho, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, Cn<span class="dv">-1</span>))</span>
<span id="cb14-6"><a href="#cb14-6"></a>  M =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(S, E0)</span>
<span id="cb14-7"><a href="#cb14-7"></a>  </span>
<span id="cb14-8"><a href="#cb14-8"></a>  Ei =<span class="st"> </span>E0</span>
<span id="cb14-9"><a href="#cb14-9"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>In) M =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(M, Ei)</span>
<span id="cb14-10"><a href="#cb14-10"></a>  </span>
<span id="cb14-11"><a href="#cb14-11"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>(In<span class="dv">-1</span>)){</span>
<span id="cb14-12"><a href="#cb14-12"></a>    Ii=<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>((<span class="dv">1</span><span class="op">-</span>A)<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>Q), A<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>Q), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>,i), A<span class="op">*</span>Q, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, In<span class="op">-</span>i<span class="dv">-1</span>), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>,i), (<span class="dv">1</span><span class="op">-</span>A)<span class="op">*</span>Q, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, In<span class="op">-</span>i<span class="dv">-1</span>), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, Cn))</span>
<span id="cb14-13"><a href="#cb14-13"></a>    M =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(M, Ii)</span>
<span id="cb14-14"><a href="#cb14-14"></a>  }</span>
<span id="cb14-15"><a href="#cb14-15"></a>  </span>
<span id="cb14-16"><a href="#cb14-16"></a>  Im=<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>( (<span class="dv">1</span><span class="op">-</span>A)<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>Q), A<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>Q), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>,In<span class="dv">-1</span>), A<span class="op">*</span>Q,  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>,In<span class="dv">-1</span>), (<span class="dv">1</span><span class="op">-</span>A)<span class="op">*</span>Q, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, Cn))</span>
<span id="cb14-17"><a href="#cb14-17"></a>  M =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(M, Im)</span>
<span id="cb14-18"><a href="#cb14-18"></a>  </span>
<span id="cb14-19"><a href="#cb14-19"></a>  <span class="cf">if</span>(Cn<span class="op">==</span><span class="dv">2</span>){</span>
<span id="cb14-20"><a href="#cb14-20"></a>    C1 =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, <span class="dv">2</span><span class="op">*</span>In<span class="op">+</span><span class="dv">1</span>),<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb14-21"><a href="#cb14-21"></a>    M =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(M, C1)</span>
<span id="cb14-22"><a href="#cb14-22"></a>    C2 =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, <span class="dv">2</span><span class="op">*</span>In<span class="op">+</span><span class="dv">1</span>),<span class="dv">0</span>,<span class="dv">0</span>)</span>
<span id="cb14-23"><a href="#cb14-23"></a>    M =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(M, C2)</span>
<span id="cb14-24"><a href="#cb14-24"></a>  }</span>
<span id="cb14-25"><a href="#cb14-25"></a>  M</span>
<span id="cb14-26"><a href="#cb14-26"></a>}</span>
<span id="cb14-27"><a href="#cb14-27"></a></span>
<span id="cb14-28"><a href="#cb14-28"></a>makeV =<span class="st"> </span><span class="cf">function</span>(PAR, Bfn){</span>
<span id="cb14-29"><a href="#cb14-29"></a> PAR<span class="op">$</span>A=<span class="dv">0</span></span>
<span id="cb14-30"><a href="#cb14-30"></a> <span class="kw">Bfn</span>(PAR)</span>
<span id="cb14-31"><a href="#cb14-31"></a>}</span>
<span id="cb14-32"><a href="#cb14-32"></a></span>
<span id="cb14-33"><a href="#cb14-33"></a>makeW =<span class="st"> </span><span class="cf">function</span>(PAR, Bfn){</span>
<span id="cb14-34"><a href="#cb14-34"></a>  V =<span class="st"> </span><span class="kw"><a href="../reference/makeV.html">makeV</a></span>(PAR, Bfn)</span>
<span id="cb14-35"><a href="#cb14-35"></a> (<span class="kw">Bfn</span>(PAR)<span class="op">-</span>V)<span class="op">/</span>PAR<span class="op">$</span>A</span>
<span id="cb14-36"><a href="#cb14-36"></a>}</span>
<span id="cb14-37"><a href="#cb14-37"></a></span>
<span id="cb14-38"><a href="#cb14-38"></a>PAR<span class="op">$</span>Cn =<span class="st"> </span><span class="dv">2</span></span>
<span id="cb14-39"><a href="#cb14-39"></a>X =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="fl">0.05</span>, <span class="fl">0.35</span>, <span class="fl">0.01</span>)</span>
<span id="cb14-40"><a href="#cb14-40"></a>X =<span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.1</span><span class="op">*</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Trig">sin</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="dv">0</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(X), <span class="dt">length.out =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(X))))<span class="op">*</span>X</span>
<span id="cb14-41"><a href="#cb14-41"></a>ARdrugs_age =<span class="st"> </span><span class="kw"><a href="../reference/PR2AReq.html">PR2AReq</a></span>(X, PAR, makeBdrugs_age)</span>
<span id="cb14-42"><a href="#cb14-42"></a><span class="co">#&gt; [1] "max A: 0.185; max X: 0.322"</span></span>
<span id="cb14-43"><a href="#cb14-43"></a><span class="co">#&gt; [1] "Non-monotonic"</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="co">## Generic forward simulation function</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>simAR &lt;-<span class="st"> </span><span class="cf">function</span>(X, PAR, Bfn) {  </span>
<span id="cb15-3"><a href="#cb15-3"></a>  V =<span class="st"> </span><span class="kw"><a href="../reference/makeV.html">makeV</a></span>(PAR, Bfn)</span>
<span id="cb15-4"><a href="#cb15-4"></a>  W =<span class="st"> </span><span class="kw"><a href="../reference/makeW.html">makeW</a></span>(PAR, Bfn)</span>
<span id="cb15-5"><a href="#cb15-5"></a>  D =<span class="st"> </span><span class="kw"><a href="../reference/makeD.html">makeD</a></span>(PAR)</span>
<span id="cb15-6"><a href="#cb15-6"></a>  outY &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">matrix</a></span>(<span class="dt">nrow =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(D), <span class="dt">ncol =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(X))</span>
<span id="cb15-7"><a href="#cb15-7"></a>  <span class="cf">if</span>(PAR<span class="op">$</span>In <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>) {</span>
<span id="cb15-8"><a href="#cb15-8"></a>      params =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/optim">optim</a></span>(<span class="dt">fn =</span> fn2, <span class="dt">par =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="fl">0.1</span>), <span class="dt">PAR =</span> PAR, <span class="dt">Bfn =</span> Bfn, <span class="dt">X =</span> X)<span class="op">$</span>par</span>
<span id="cb15-9"><a href="#cb15-9"></a>      </span>
<span id="cb15-10"><a href="#cb15-10"></a>      <span class="co"># Set up equilibrium start values</span></span>
<span id="cb15-11"><a href="#cb15-11"></a>      outA =<span class="st"> </span>PAR<span class="op">$</span>A =<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(params[<span class="dv">1</span>])</span>
<span id="cb15-12"><a href="#cb15-12"></a>      Y0 =<span class="st"> </span><span class="kw"><a href="../reference/findYeq.html">findYeq</a></span>(PAR, Bfn)</span>
<span id="cb15-13"><a href="#cb15-13"></a>      outA[<span class="dv">2</span>] =<span class="st"> </span>PAR<span class="op">$</span>A =<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(params[<span class="dv">2</span>])</span>
<span id="cb15-14"><a href="#cb15-14"></a>      B =<span class="st"> </span><span class="kw">Bfn</span>(PAR)</span>
<span id="cb15-15"><a href="#cb15-15"></a>      Y =<span class="st"> </span>B<span class="op">%*%</span>Y0</span>
<span id="cb15-16"><a href="#cb15-16"></a>      outY[, <span class="dv">1</span>] =<span class="st"> </span>Y</span>
<span id="cb15-17"><a href="#cb15-17"></a>      </span>
<span id="cb15-18"><a href="#cb15-18"></a>      <span class="co"># Simulate forward</span></span>
<span id="cb15-19"><a href="#cb15-19"></a>      <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">3</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(X)) {</span>
<span id="cb15-20"><a href="#cb15-20"></a>          outA[i] =<span class="st"> </span>PAR<span class="op">$</span>A =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>((X[i] <span class="op">-</span><span class="st"> </span>D<span class="op">%*%</span>V<span class="op">%*%</span>V<span class="op">%*%</span>Y) <span class="op">/</span><span class="st"> </span>(D<span class="op">%*%</span>V<span class="op">%*%</span>W<span class="op">%*%</span>Y))</span>
<span id="cb15-21"><a href="#cb15-21"></a>          B =<span class="st"> </span><span class="kw">Bfn</span>(PAR)</span>
<span id="cb15-22"><a href="#cb15-22"></a>          Y =<span class="st"> </span>B<span class="op">%*%</span>Y</span>
<span id="cb15-23"><a href="#cb15-23"></a>          outY[, i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>] =<span class="st"> </span>Y</span>
<span id="cb15-24"><a href="#cb15-24"></a>      }</span>
<span id="cb15-25"><a href="#cb15-25"></a>  } <span class="cf">else</span> {</span>
<span id="cb15-26"><a href="#cb15-26"></a>    <span class="co"># Set up equilibrium start values</span></span>
<span id="cb15-27"><a href="#cb15-27"></a>    forwardA =<span class="st"> </span>PAR<span class="op">$</span>A =<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(eqAR<span class="op">$</span>A[<span class="dv">1</span>])</span>
<span id="cb15-28"><a href="#cb15-28"></a>    Y =<span class="st"> </span><span class="kw"><a href="../reference/findYeq.html">findYeq</a></span>(PAR, Bfn)</span>
<span id="cb15-29"><a href="#cb15-29"></a>    outY[, <span class="dv">1</span>] =<span class="st"> </span>Y</span>
<span id="cb15-30"><a href="#cb15-30"></a>    <span class="co"># Simulate forward</span></span>
<span id="cb15-31"><a href="#cb15-31"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(X)) {</span>
<span id="cb15-32"><a href="#cb15-32"></a>        forwardA[i] =<span class="st"> </span>PAR<span class="op">$</span>A =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>((X[i] <span class="op">-</span><span class="st"> </span>D<span class="op">%*%</span>V<span class="op">%*%</span>Y) <span class="op">/</span><span class="st"> </span>(D<span class="op">%*%</span>W<span class="op">%*%</span>Y))</span>
<span id="cb15-33"><a href="#cb15-33"></a>        B =<span class="st"> </span><span class="kw">Bfn</span>(PAR)</span>
<span id="cb15-34"><a href="#cb15-34"></a>        Y =<span class="st"> </span>B<span class="op">%*%</span>Y</span>
<span id="cb15-35"><a href="#cb15-35"></a>        outY[, i] =<span class="st"> </span>Y</span>
<span id="cb15-36"><a href="#cb15-36"></a>    }</span>
<span id="cb15-37"><a href="#cb15-37"></a>  }</span>
<span id="cb15-38"><a href="#cb15-38"></a>  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">A =</span> outA, <span class="dt">Y =</span> outY))</span>
<span id="cb15-39"><a href="#cb15-39"></a>}</span>
<span id="cb15-40"><a href="#cb15-40"></a></span>
<span id="cb15-41"><a href="#cb15-41"></a><span class="co">## Set up PR2AR that can take any model and return equilibrium or forward simulation values</span></span>
<span id="cb15-42"><a href="#cb15-42"></a>PR2AR &lt;-<span class="st"> </span><span class="cf">function</span>(X, PAR, <span class="dt">eq =</span> F) {</span>
<span id="cb15-43"><a href="#cb15-43"></a>  <span class="cf">if</span>(PAR<span class="op">$</span>In <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>PAR<span class="op">$</span>Cn <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) {</span>
<span id="cb15-44"><a href="#cb15-44"></a>    Bfn =<span class="st"> </span>makeBdrugs_age</span>
<span id="cb15-45"><a href="#cb15-45"></a>  } <span class="cf">else</span> <span class="cf">if</span> (PAR<span class="op">$</span>In <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>) {</span>
<span id="cb15-46"><a href="#cb15-46"></a>    Bfn =<span class="st"> </span>makeBage</span>
<span id="cb15-47"><a href="#cb15-47"></a>  } <span class="cf">else</span> <span class="cf">if</span> (PAR<span class="op">$</span>Cn <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) {</span>
<span id="cb15-48"><a href="#cb15-48"></a>    Bfn =<span class="st"> </span>makeBdrugs</span>
<span id="cb15-49"><a href="#cb15-49"></a>  } <span class="cf">else</span> {</span>
<span id="cb15-50"><a href="#cb15-50"></a>    Bfn =<span class="st"> </span>makeB</span>
<span id="cb15-51"><a href="#cb15-51"></a>  }</span>
<span id="cb15-52"><a href="#cb15-52"></a>  <span class="cf">if</span>(eq) {</span>
<span id="cb15-53"><a href="#cb15-53"></a>    outList &lt;-<span class="st"> </span><span class="kw"><a href="../reference/PR2AReq.html">PR2AReq</a></span>(X, PAR, Bfn)</span>
<span id="cb15-54"><a href="#cb15-54"></a>  } <span class="cf">else</span> {</span>
<span id="cb15-55"><a href="#cb15-55"></a>    outList &lt;-<span class="st"> </span><span class="kw"><a href="../reference/simAR.html">simAR</a></span>(X, PAR, Bfn)</span>
<span id="cb15-56"><a href="#cb15-56"></a>  }</span>
<span id="cb15-57"><a href="#cb15-57"></a>  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(outList)</span>
<span id="cb15-58"><a href="#cb15-58"></a>}</span>
<span id="cb15-59"><a href="#cb15-59"></a>forwardA =<span class="st"> </span><span class="kw"><a href="../reference/PR2AR.html">PR2AR</a></span>(X, PAR, <span class="dt">eq =</span> F)<span class="op">$</span>A</span>
<span id="cb15-60"><a href="#cb15-60"></a>eqA =<span class="st"> </span><span class="kw"><a href="../reference/PR2AR.html">PR2AR</a></span>(X, PAR, <span class="dt">eq =</span> T)<span class="op">$</span>A</span>
<span id="cb15-61"><a href="#cb15-61"></a><span class="co">#&gt; [1] "max A: 0.185; max X: 0.322"</span></span>
<span id="cb15-62"><a href="#cb15-62"></a><span class="co">#&gt; [1] "Non-monotonic"</span></span>
<span id="cb15-63"><a href="#cb15-63"></a></span>
<span id="cb15-64"><a href="#cb15-64"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(eqA, <span class="dt">type =</span> <span class="st">"l"</span>, <span class="dt">ylab =</span> <span class="st">"A"</span>, </span>
<span id="cb15-65"><a href="#cb15-65"></a>     <span class="dt">ylim =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(eqA, forwardA), <span class="dt">na.rm =</span> T), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(eqA, forwardA), <span class="dt">na.rm =</span> T)))</span>
<span id="cb15-66"><a href="#cb15-66"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/abline">abline</a></span>(<span class="dt">h =</span> max<span class="op">$</span>X, <span class="dt">col =</span> <span class="st">"red"</span>)</span>
<span id="cb15-67"><a href="#cb15-67"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(forwardA, <span class="dt">lty =</span> <span class="st">"dashed"</span>)</span>
<span id="cb15-68"><a href="#cb15-68"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/legend">legend</a></span>(<span class="st">"topleft"</span>, <span class="dt">legend =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"Steady"</span>, <span class="st">"Forward"</span>), <span class="dt">lty =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)</span></code></pre></div>
<p><img src="PR2AR_Primer_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
</div>
<div id="heterogeneity-in-attack-rates" class="section level2">
<h2 class="hasAnchor">
<a href="#heterogeneity-in-attack-rates" class="anchor"></a>Heterogeneity in Attack-Rates</h2>
</div>
<div id="heterogeneity-in-treatment-habits" class="section level2">
<h2 class="hasAnchor">
<a href="#heterogeneity-in-treatment-habits" class="anchor"></a>Heterogeneity in Treatment Habits</h2>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#motivation">Motivation</a></li>
      <li><a href="#a-bad-start">A Bad Start</a></li>
      <li><a href="#a-better-start">A Better Start</a></li>
      <li><a href="#matrix-form">Matrix Form</a></li>
      <li><a href="#steady-state">Steady State</a></li>
      <li><a href="#forward-simulation-vs--steady-state">Forward Simulation vs. Steady State</a></li>
      <li><a href="#adding-drugs">Adding Drugs</a></li>
      <li><a href="#pfpr-thresholds-and-ar2pr-monotonicity"><span class="math inline">\(Pf\)</span>PR Thresholds and AR2PR Monotonicity</a></li>
      <li><a href="#age-of-infection-aoi-and-overwriting-superinfection">Age of Infection (AoI) and Overwriting Superinfection</a></li>
      <li><a href="#aoi-forward-simulation">AoI Forward Simulation</a></li>
      <li><a href="#combine-aoi-with-overwriting-superinfection-and-drugs">Combine AoI with Overwriting Superinfection and Drugs</a></li>
      <li><a href="#heterogeneity-in-attack-rates">Heterogeneity in Attack-Rates</a></li>
      <li><a href="#heterogeneity-in-treatment-habits">Heterogeneity in Treatment Habits</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Austin Carter.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
